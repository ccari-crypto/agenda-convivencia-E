<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="SGI Cloud">
    <meta name="theme-color" content="#1e293b">
    
    <title> SGI Cloud Pro v9.3</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" type="text/css" href="https://npmcdn.com/flatpickr/dist/themes/airbnb.css">
    
    <style>
        :root {
            --primary: #6366f1; --primary-light: #818cf8; --primary-dark: #4338ca;
            --bg-sidebar: #1e293b; --secondary: #64748b; --success: #10b981;
            --warning: #f59e0b; --danger: #ef4444; --whatsapp: #25D366;
            --bg-body: #f8fafc; --bg-card: #ffffff; --bg-glass: rgba(255, 255, 255, 0.95);
            --text-main: #0f172a; --text-light: #64748b; --border: #e2e8f0;
            --radius: 16px; --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --safe-top: env(safe-area-inset-top, 0px);
            --safe-bottom: env(safe-area-inset-bottom, 0px);
            --safe-left: env(safe-area-inset-left, 0px);
            --safe-right: env(safe-area-inset-right, 0px);
        }
        [data-theme="dark"] { --bg-body: #0f172a; --bg-card: #1e293b; --bg-glass: rgba(30, 41, 59, 0.95); --text-main: #f1f5f9; --text-light: #94a3b8; --border: #334155; }
        
        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }
        
        body { font-family: 'Inter', sans-serif; background: var(--bg-body); color: var(--text-main); font-size: 14px; overflow: hidden; height: 100vh; height: 100dvh; transition: var(--transition); }

        /* LAYOUT */
        .container { height: 100%; display: flex; flex-direction: column; padding-left: var(--safe-left); padding-right: var(--safe-right); }
        .main-header { background: var(--bg-glass); padding: calc(0.8rem + var(--safe-top)) 1.5rem 0.8rem 1.5rem; backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-bottom: 1px solid var(--border); flex-shrink: 0; z-index: 50; display: flex; justify-content: space-between; align-items: center; min-height: 70px; position: relative; }
        .app-wrapper { display: flex; flex: 1; overflow: hidden; height: 100%; position: relative; }
        .sidebar { width: 240px; background: var(--bg-sidebar); color: #cbd5e1; display: flex; flex-direction: column; flex-shrink: 0; border-right: 1px solid var(--border); height: 100%; overflow: hidden; transition: transform 0.3s ease, width 0.3s ease; }
        .sidebar-content, .main-content { -webkit-overflow-scrolling: touch; overscroll-behavior-y: contain; }
        .sidebar-content { padding: 1rem; overflow-y: auto; flex: 1; display: flex; flex-direction: column; gap: 1.5rem; padding-bottom: calc(2rem + var(--safe-bottom)); }
        .main-content { flex: 1; padding: 1.5rem; overflow-y: auto; height: 100%; background-color: var(--bg-body); background-size: cover; background-position: center; background-attachment: local; position: relative; transition: background-image 0.5s ease-in-out; padding-bottom: calc(5rem + var(--safe-bottom)); }
        .main-content::before { content: ''; position: fixed; inset: 0; background: rgba(255,255,255,0.0); pointer-events: none; z-index: 0; }

        /* UI ELEMENTS */
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 6px; padding: 10px 16px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: var(--transition); border: none; font-size: 0.9rem; touch-action: manipulation; }
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3); }
        .btn-secondary { background: transparent; border: 1px solid var(--border); color: var(--text-main); }
        .btn-danger { background: rgba(239, 68, 68, 0.1); color: var(--danger); }
        .btn-whatsapp { background: var(--whatsapp); color: white; }
        .btn-mail { background: #EA4335; color: white; }
        .btn-sync { background: rgba(16, 185, 129, 0.1); color: var(--success); border: 1px solid rgba(16, 185, 129, 0.2); }
        .btn-sync:hover { background: var(--success); color: white; }
        .btn-sync.rotating i { animation: spin 1s linear infinite; }
        .badge { padding: 3px 8px; border-radius: 12px; font-size: 0.7rem; font-weight: 600; display: inline-block; }
        input, select, textarea, .form-control { font-size: 16px !important; border-radius: 8px; appearance: none; -webkit-appearance: none; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* HEADER */
        .profile-pic-container { width: 45px; height: 45px; border-radius: 50%; overflow: hidden; display: flex; align-items: center; justify-content: center; background: rgba(99, 102, 241, 0.1); border: 2px solid var(--primary); }
        .profile-pic-img { width: 100%; height: 100%; object-fit: cover; display: none; }
        .header-logo-center { position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); max-height: 50px; max-width: 150px; display: none; pointer-events: none;}
        .app-subtitle { font-size: 0.8rem; font-weight: 600; color: var(--text-light); line-height: 1.2; }
        .connection-indicator { display: flex; align-items: center; gap: 8px; padding: 6px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; transition: all 0.3s ease; border: 1px solid transparent; }
        .status-online { background: rgba(16, 185, 129, 0.1); color: var(--success); border-color: rgba(16, 185, 129, 0.2); }
        .status-offline { background: rgba(239, 68, 68, 0.1); color: var(--danger); border-color: rgba(239, 68, 68, 0.2); }
        .status-syncing { background: rgba(245, 158, 11, 0.1); color: var(--warning); border-color: rgba(245, 158, 11, 0.2); }

        /* NAV & WIDGETS */
        .nav-category { font-size: 0.7rem; text-transform: uppercase; color: #64748b; margin-bottom: 0.5rem; padding-left: 8px; font-weight: 600; }
        .nav-item { width: 100%; display: flex; align-items: center; gap: 10px; padding: 12px 12px; background: transparent; border: none; color: #94a3b8; cursor: pointer; border-radius: 10px; font-weight: 500; font-family: inherit; transition: var(--transition); text-align: left; font-size: 0.95rem; }
        .nav-item:hover { background: rgba(255,255,255,0.05); color: #fff; transform: translateX(3px); }
        .nav-item.active { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: #fff; box-shadow: 0 4px 15px rgba(0,0,0, 0.2); }
        .view-container { display: none; animation: fadeSlideUp 0.3s ease forwards; padding-bottom: 80px; position: relative; z-index: 1; }
        .view-container.active { display: block; }
        @keyframes fadeSlideUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

        /* WIDGETS & GRID */
        .widget-grid-top { display: grid; grid-template-columns: 3fr 1fr; gap: 15px; margin-bottom: 15px; }
        .widget-grid-mid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .widget-card { background: var(--bg-card); padding: 15px; border-radius: 16px; border: 1px solid var(--border); box-shadow: 0 4px 20px rgba(0,0,0,0.03); position: relative; overflow: hidden; display: flex; flex-direction: column; }
        .widget-quote { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: white; border: none; display: flex; flex-direction: row; align-items: center; gap: 15px; }
        .quote-icon { font-size: 2rem; opacity: 0.8; background: rgba(255,255,255,0.2); width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .task-progress-bg { background: var(--border); height: 6px; border-radius: 4px; width: 100%; overflow: hidden; margin-top: auto; }
        .task-progress-fill { height: 100%; background: var(--success); width: 0%; transition: width 1s ease; border-radius: 4px; }
        .widget-countdown { background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); color: white; border: none; text-align: center; justify-content: center; }
        .countdown-time { font-size: 2.2rem; font-weight: 800; font-family: monospace; letter-spacing: -1px; margin: 5px 0; color: #fbbf24; }
        .widget-event { border-left: 4px solid #8b5cf6; }
        .links-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .quick-link { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 10px; background: var(--bg-body); border-radius: 12px; text-decoration: none; color: var(--text-main); border: 1px solid var(--border); }
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.8rem; margin-bottom: 1rem; }
        .stat-card { display: flex; align-items: center; justify-content: space-between; cursor: pointer; padding: 0.5rem 0.8rem; background: var(--bg-card); border-radius: var(--radius); border: 1px solid var(--border); }
        .dashboard-row { display: grid; grid-template-columns: 2fr 1fr; gap: 1rem; }
        
        /* NOTAS & LISTAS */
        .sticky-notes-grid { display: flex; flex-wrap: wrap; gap: 10px; align-items: flex-start; }
        .sticky-note { padding: 8px; border-radius: 8px; width: 160px; height: 140px; min-width: 120px; min-height: 100px; resize: both; overflow: hidden; position: relative; box-shadow: 1px 1px 4px rgba(0,0,0,0.15); display: flex; flex-direction: column; }
        .sticky-note-content { flex-grow: 1; width: 100%; border: none; background: transparent; resize: none; font-family: 'Inter', sans-serif; font-size: 0.9rem; color: #1e293b; outline: none; }
        .note-colors { display: flex; gap: 4px; margin-top: 4px; opacity: 0; transition: 0.2s; flex-wrap: wrap; justify-content: center; background: rgba(255,255,255,0.8); padding: 3px; border-radius: 8px; }
        .sticky-note:hover .note-colors { opacity: 1; }
        .color-dot { width: 12px; height: 12px; border-radius: 50%; cursor: pointer; border: 1px solid rgba(0,0,0,0.2); }
        .note-delete { position: absolute; top: 4px; right: 4px; cursor: pointer; opacity: 0.5; font-size: 0.7rem; }
        .cases-table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 0.85rem; }
        .cases-table th, .cases-table td { padding: 8px 10px; border-bottom: 1px solid var(--border); background: var(--bg-card); text-align: left; }
        
        /* LISTA DE ACTIVIDADES (CHECKBOX MEJORADO) */
        .activity-item { 
            display: flex; 
            justify-content: space-between; 
            padding: 15px; 
            border-bottom: 1px solid var(--border); 
            align-items: center; 
            cursor: pointer; 
            transition: background-color 0.2s, border-left 0.2s, transform 0.2s;
            border-left: 4px solid transparent; 
        }
        .activity-item:hover { background-color: var(--bg-body); }
        .activity-item.selected {
            background-color: rgba(99, 102, 241, 0.1);
            border-left: 4px solid var(--primary);
            transform: translateX(2px);
        }
        .activity-item.selected strong { color: var(--primary); }
        .item-checkbox {
            width: 22px; height: 22px; margin-right: 15px; cursor: pointer;
            accent-color: var(--primary); transition: transform 0.2s;
        }
        .activity-item.selected .item-checkbox { transform: scale(1.1); }

        /* BARRA DE ACCIN FLOTANTE (MINIMALISTA + Z-INDEX BAJO) */
        .bulk-action-bar { 
            position: fixed; 
            bottom: calc(30px + var(--safe-bottom)); 
            left: 50%; 
            transform: translateX(-50%) translateY(150px); 
            background: rgba(15, 23, 42, 0.9); 
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            padding: 10px 25px; 
            border-radius: 50px; 
            display: flex; 
            gap: 20px; 
            align-items: center; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.3); 
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            z-index: 900; 
            border: 1px solid rgba(255,255,255,0.1); 
        }
        .bulk-action-bar.visible { transform: translateX(-50%) translateY(0); }
        
        .bulk-count-container {
            display: flex; align-items: center; gap: 6px;
            padding-right: 15px; border-right: 1px solid rgba(255,255,255,0.2);
            color: white; font-weight: 600; font-size: 0.9rem;
        }
        .bulk-count {
            background: var(--primary); color: white;
            padding: 2px 8px; border-radius: 10px; font-size: 0.8rem;
        }
        .bulk-btn-icon {
            background: transparent; border: none; color: white;
            font-size: 1.3rem; cursor: pointer; padding: 5px;
            transition: transform 0.2s, color 0.2s; display: flex;
            align-items: center; justify-content: center;
        }
        .bulk-btn-icon:hover { transform: scale(1.2); color: var(--primary-light); }
        
        /* CALENDAR & GANTT */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); background: var(--border); gap: 1px; border: 1px solid var(--border); border-radius: 12px; overflow: hidden; grid-auto-rows: minmax(100px, auto); }
        .calendar-day { background: var(--bg-card); padding: 4px; cursor: pointer; overflow: hidden; display: flex; flex-direction: column; }
        .cal-event { padding: 2px 5px; font-size: 0.75rem; border-radius: 3px; margin-bottom: 2px; color: white; cursor: pointer; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; position: relative; max-width: 100%; }
        .custom-tooltip { position: fixed; background: rgba(15, 23, 42, 0.95); color: white; padding: 10px 14px; border-radius: 6px; font-size: 0.8rem; z-index: 9999; pointer-events: none; display: none; box-shadow: 0 4px 15px rgba(0,0,0,0.3); max-width: 250px; backdrop-filter: blur(4px); }
        .gantt-wrapper { overflow-x: auto; border: 1px solid var(--border); border-radius: 8px; background: var(--bg-card); -webkit-overflow-scrolling: touch; }
        .gantt-header { display: flex; border-bottom: 1px solid var(--border); background: var(--bg-body); }
        .gantt-cell { flex: 1; min-width: 35px; padding: 4px; text-align: center; border-right: 1px solid var(--border); font-size: 0.7rem; }
        .gantt-row { display: flex; border-bottom: 1px solid var(--border); height: 36px; position: relative; align-items: center; }
        .gantt-bar { position: absolute; height: 24px; border-radius: 4px; top: 6px; font-size: 0.75rem; color: white; cursor: pointer; z-index: 5; display: flex; align-items: center; gap: 6px; padding: 0 8px; white-space: nowrap; overflow: hidden; transition: filter 0.2s, transform 0.2s, z-index 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .gantt-bar:hover { filter: brightness(115%); z-index: 50; transform: scale(1.02); }
        .gantt-label { width: 180px; flex-shrink: 0; padding: 0 8px; font-size: 0.8rem; font-weight: 500; border-right: 1px solid var(--border); background: var(--bg-card); position: sticky; left: 0; z-index: 10; display: flex; align-items: center; height: 100%; }
        
        /* ALARMS & MODALS */
        .alarm-modal { position: fixed; inset: 0; z-index: 9999; display: none; flex-direction: column; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .alarm-modal.active { display: flex; }
        .alarm-box { background: white; padding: 40px; border-radius: 30px; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.5); max-width: 500px; width: 90%; }
        .alarm-title { font-size: 2.5rem; font-weight: 900; color: #1e293b; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 2px; }
        .alarm-desc { font-size: 1.4rem; color: #64748b; margin-bottom: 40px; font-weight: 500; }
        .btn-alarm-off { font-size: 1.5rem; padding: 20px 50px; border: none; border-radius: 50px; cursor: pointer; font-weight: 800; text-transform: uppercase; color: white; transition: 0.2s; }
        .alarm-nuclear { background: rgba(239, 68, 68, 0.95); animation: pulseBg 1s infinite alternate; }
        .alarm-nuclear .alarm-box { animation: shake 0.5s both infinite; }
        .alarm-nuclear .btn-alarm-off { background: var(--danger); box-shadow: 0 10px 20px rgba(239, 68, 68, 0.4); }
        .alarm-gentle { background: rgba(59, 130, 246, 0.95); }
        .alarm-gentle .alarm-box { animation: float 3s infinite ease-in-out; }
        .alarm-gentle .btn-alarm-off { background: #3b82f6; box-shadow: 0 10px 20px rgba(59, 130, 246, 0.4); }
        .alarm-quick { background: rgba(16, 185, 129, 0.95); }
        .alarm-quick .btn-alarm-off { background: #10b981; box-shadow: 0 10px 20px rgba(16, 185, 129, 0.4); }
        @keyframes pulseBg { 0% { background: rgba(239, 68, 68, 0.9); } 100% { background: rgba(185, 28, 28, 0.95); } }
        @keyframes shake { 0% { transform: translate(1px, 1px) rotate(0deg); } 10% { transform: translate(-1px, -2px) rotate(-1deg); } 20% { transform: translate(-3px, 0px) rotate(1deg); } 30% { transform: translate(3px, 2px) rotate(0deg); } 40% { transform: translate(1px, -1px) rotate(1deg); } 50% { transform: translate(-1px, 2px) rotate(-1deg); } 60% { transform: translate(-3px, 1px) rotate(0deg); } 70% { transform: translate(3px, 1px) rotate(-1deg); } 80% { transform: translate(-1px, -1px) rotate(1deg); } 90% { transform: translate(1px, 2px) rotate(0deg); } 100% { transform: translate(1px, -2px) rotate(-1deg); } }
        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-15px); } 100% { transform: translateY(0px); } }
        
        .notification { position: fixed; bottom: calc(30px + var(--safe-bottom)); right: 30px; padding: 12px 20px; border-radius: 10px; background: var(--bg-sidebar); color: white; transform: translateY(200px); opacity: 0; transition: var(--transition); z-index: 2000; font-size: 0.9rem; max-width: 80vw; }
        .notification.show { transform: translateY(0); opacity: 1; }
        .fab { position: fixed; bottom: calc(25px + var(--safe-bottom)); right: 25px; width: 55px; height: 55px; border-radius: 50%; background: var(--primary); color: white; display: flex; align-items: center; justify-content: center; font-size: 1.4rem; box-shadow: 0 4px 15px rgba(0,0,0, 0.3); cursor: pointer; transition: transform 0.2s; z-index: 100; border: none; }
        .fab:hover { transform: scale(1.1); }
        
        /* MODALS */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); backdrop-filter: blur(5px); z-index: 1000; display: none; align-items: center; justify-content: center; }
        .modal-overlay.active { display: flex; }
        .modal-container { background: var(--bg-card); width: 95%; max-width: 750px; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); overflow: hidden; max-height: 90vh; display: flex; flex-direction: column; margin-bottom: var(--safe-bottom); }
        .modal-header { padding: 1.2rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; font-weight: 700; font-size: 1.1rem; }
        .modal-body { padding: 1.5rem; overflow-y: auto; -webkit-overflow-scrolling: touch; }
        .form-control { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px; background: var(--bg-body); color: var(--text-main); margin-bottom: 12px; display: block; }

        /* HORARIO DE CLASES */
        .schedule-table { width:100%; border-collapse:collapse; background:var(--bg-card); border-radius:var(--radius); overflow:hidden; }
        .schedule-table th { padding:12px; text-align:center; min-width:80px; background:var(--primary); color:white; position:sticky; top:0; z-index:10; }
        .schedule-table td { padding:12px; text-align:center; border:1px solid var(--border); position:relative; min-width:120px; transition:all 0.2s; user-select:none; }
        
        .schedule-editor-mode .schedule-table td { cursor:pointer; }
        .schedule-editor-mode .schedule-table td:hover { filter:brightness(0.95); }
        .schedule-editor-mode .schedule-table td.selected { box-shadow:inset 0 0 0 3px var(--primary); z-index:5; }
        
        /* CORRECCIN: Estilos para la columna de horas */
        .schedule-table td:first-child { white-space: nowrap; font-weight: 700; font-size: 0.85rem; }

        .hour-controls { display:flex; flex-direction:column; gap:5px; position:absolute; left:-40px; top:50%; transform:translateY(-50%); }
        .hour-controls button { width:30px; height:30px; border-radius:50%; display:flex; align-items:center; justify-content:center; background:var(--bg-card); border:1px solid var(--border); cursor:pointer; font-size:0.7rem; }
        
        .class-picker { position:fixed; background:var(--bg-card); border:2px solid var(--primary); border-radius:12px; padding:15px; z-index:1000; box-shadow:0 10px 30px rgba(0,0,0,0.2); display:none; flex-wrap:wrap; gap:8px; max-width:300px; max-height:300px; overflow-y:auto; }
        .class-picker.active { display:flex; }
        .class-option { padding:8px 12px; border-radius:8px; cursor:pointer; border:1px solid var(--border); transition:all 0.2s; position:relative; }
        .class-option:hover { transform:scale(1.05); }
        .class-option .delete-class { position:absolute; top:-5px; right:-5px; background:var(--danger); color:white; border-radius:50%; width:18px; height:18px; display:flex; align-items:center; justify-content:center; font-size:0.6rem; cursor:pointer; opacity:0; transition:opacity 0.2s; }
        .class-option:hover .delete-class { opacity:1; }
        
        .schedule-actions { display:flex; gap:10px; margin-bottom:15px; flex-wrap:wrap; }
        .schedule-actions .btn { padding:8px 12px; font-size:0.8rem; }
        
        .time-edit-input { width:95px; padding:4px; border:1px solid var(--border); border-radius:4px; text-align:center; font-size: 14px; }
        
        .selection-info { background:var(--bg-card); padding:10px 15px; border-radius:var(--radius); border:1px solid var(--border); margin-bottom:15px; display:flex; justify-content:space-between; align-items:center; flex-wrap: wrap; gap: 10px; }
        .selection-info span { font-weight:600; color:var(--primary); }
        
        .add-materia-form { display:flex; gap:10px; margin-bottom:15px; }
        .add-materia-form input { flex:1; }
        .color-preview { width:30px; height:30px; border-radius:6px; border:2px solid var(--border); cursor:pointer; }
        .color-palette { display:grid; grid-template-columns:repeat(8, 1fr); gap:5px; margin-top:10px; }
        .color-palette div { width:25px; height:25px; border-radius:4px; cursor:pointer; border:1px solid rgba(0,0,0,0.1); }
        
        .sidebar-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 55; opacity: 0; pointer-events: none; transition: opacity 0.3s; backdrop-filter: blur(2px); }
        .sidebar-overlay.active { opacity: 1; pointer-events: auto; }

        @media (max-width: 900px) { 
            .sidebar { position: fixed; height: 100%; z-index: 60; transform: translateX(-100%); width: 280px; box-shadow: 2px 0 10px rgba(0,0,0,0.2); } 
            .sidebar.open { transform: translateX(0); } 
            .dashboard-row { grid-template-columns: 1fr; } 
            .widget-grid-top, .widget-grid-mid { grid-template-columns: 1fr; }
            .schedule-table { font-size:0.8rem; }
            .schedule-table th, .schedule-table td { padding:8px 4px; }
            .hour-controls { left:-30px; }
            .color-palette { grid-template-columns:repeat(4, 1fr); }
            .main-content { padding: 1rem; }
            .gantt-label { width: 120px; }
            .card { overflow-x: auto; }
        }
    </style>
</head>
<body>

    <div id="notification" class="notification"><i class="fas fa-info-circle"></i> <span id="notifText"></span></div>
    <div id="ganttTooltip" class="custom-tooltip"></div>
    <div id="calendarTooltip" class="custom-tooltip"></div>

    <div id="bulkActionBar" class="bulk-action-bar">
        <div class="bulk-count-container">
            <span id="bulkCount" class="bulk-count">0</span>
            <span>Seleccionadas</span>
        </div>
        <button class="bulk-btn-icon" onclick="window.shareSelected('whatsapp')" title="Compartir WhatsApp">
            <i class="fab fa-whatsapp"></i>
        </button>
        <button class="bulk-btn-icon" onclick="window.shareSelected('email')" title="Enviar Correo">
            <i class="fas fa-envelope"></i>
        </button>
        <button class="bulk-btn-icon" onclick="window.clearSelection()" title="Cancelar" style="margin-left:5px; color:#ef4444;">
            <i class="fas fa-times"></i>
        </button>
    </div>
    
    <div id="sidebarOverlay" class="sidebar-overlay" onclick="window.toggleSidebarFunc()"></div>

    <div id="addClassModal" class="modal-overlay">
        <div class="modal-container">
            <div class="modal-header">Agregar Nueva Materia <button style="background:none; border:none; font-size:1.5rem;" onclick="window.closeModals()">&times;</button></div>
            <div class="modal-body">
                <div class="add-materia-form">
                    <input type="text" id="newClassName" class="form-control" placeholder="Nombre de la materia" style="flex:1;">
                    <div id="newClassColorPreview" class="color-preview" style="background:#3b82f6;"></div>
                    <button class="btn btn-primary" onclick="window.addNewClass()">Agregar</button>
                </div>
                <div style="margin-top:20px;">
                    <label class="form-label">Seleccionar Color</label>
                    <div class="color-palette">
                        <div style="background:#3b82f6;" onclick="window.selectClassColor('#3b82f6')"></div>
                        <div style="background:#6366f1;" onclick="window.selectClassColor('#6366f1')"></div>
                        <div style="background:#10b981;" onclick="window.selectClassColor('#10b981')"></div>
                        <div style="background:#f59e0b;" onclick="window.selectClassColor('#f59e0b')"></div>
                        <div style="background:#ef4444;" onclick="window.selectClassColor('#ef4444')"></div>
                        <div style="background:#8b5cf6;" onclick="window.selectClassColor('#8b5cf6')"></div>
                        <div style="background:#ec4899;" onclick="window.selectClassColor('#ec4899')"></div>
                        <div style="background:#14b8a6;" onclick="window.selectClassColor('#14b8a6')"></div>
                        <div style="background:#64748b;" onclick="window.selectClassColor('#64748b')"></div>
                        <div style="background:#f1f5f9; border:2px solid #ccc;" onclick="window.selectClassColor('#f1f5f9')"></div>
                    </div>
                </div>
                <div style="margin-top:20px; padding-top:15px; border-top:1px solid var(--border);">
                    <label class="form-label">Materias Personalizadas</label>
                    <div id="customClassesList" style="display:flex; flex-wrap:wrap; gap:8px; margin-top:10px;"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="alarmModal" class="alarm-modal">
        <div class="alarm-box">
            <i class="fas fa-bell alarm-icon" style="font-size: 4rem; color: var(--danger); margin-bottom: 20px;"></i>
            <div class="alarm-title" id="alarmTitle">隆Recordatorio!</div>
            <div class="alarm-desc" id="alarmDesc">Tienes una actividad pendiente.</div>
            <button class="btn-alarm-off" onclick="window.stopAlarm()">Entendido</button>
        </div>
    </div>

    <div class="container">
        <header class="main-header">
            <img id="headerLogoCenter" class="header-logo-center" src="" alt="Logo">
            <div style="display: flex; align-items: center; gap: 10px; position:relative; z-index:2;">
                <button id="toggleSidebar" class="btn-secondary" style="border:none; background:transparent; font-size:1.2rem; margin-right:5px; padding: 5px;"><i class="fas fa-bars"></i></button>
                <div class="profile-pic-container">
                    <i class="fas fa-graduation-cap" id="defaultIcon" style="font-size: 1.5rem; color: var(--primary);"></i>
                    <img id="profilePicImg" class="profile-pic-img" src="" alt="Perfil">
                </div>
                <div>
                    <h1>Convivencia Cloud</h1>
                    <div id="appSubtitleDisplay" class="app-subtitle"></div>
                    <p id="currentDate" style="font-size: 0.75rem; opacity: 0.8;">Cargando...</p>
                </div>
            </div>
            <div style="display:flex; gap:10px; align-items:center; position:relative; z-index:2;">
                <button class="btn btn-sync" onclick="window.manualSync()" title="Forzar Sincronizaci贸n" style="padding: 8px;">
                    <i class="fas fa-sync-alt" id="syncIcon"></i> <span style="display:none; @media(min-width:600px){display:inline;}">Sync</span>
                </button>
                <div id="connectionStatus" class="connection-indicator status-offline" title="Estado de conexi贸n">
                    <i class="fas fa-wifi-slash status-icon"></i>
                </div>
                <button class="btn btn-secondary" id="themeToggle" style="padding: 8px;"><i class="fas fa-moon"></i></button>
            </div>
        </header>

        <div class="app-wrapper">
            <aside class="sidebar" id="sidebar">
                <div class="sidebar-content">
                    <div>
                        <div class="nav-category">Principal</div>
                        <button class="nav-item active" onclick="window.switchView('dashboard')"><i class="fas fa-th-large"></i> Dashboard</button>
                        <button class="nav-item" onclick="window.switchView('calendar')"><i class="fas fa-calendar-alt"></i> Calendario</button>
                        <button class="nav-item" onclick="window.switchView('gantt')"><i class="fas fa-stream"></i> Carta Gantt</button>
                    </div>
                    <div>
                        <div class="nav-category">Gesti贸n</div>
                        <button class="nav-item" onclick="window.switchView('cases')"><i class="fas fa-book-open"></i> Bit谩cora <span class="badge" id="sidebarOpenCases" style="margin-left:auto; background:rgba(255,255,255,0.1);">0</span></button>
                        <button class="nav-item" onclick="window.switchView('list')"><i class="fas fa-list-check"></i> Actividades</button>
                        <button class="nav-item" onclick="window.switchView('schedule')"><i class="fas fa-calendar-week"></i> Horario Clases</button>
                    </div>
                    <div style="margin-top: auto;">
                        <div class="nav-category">Sistema</div>
                        <button class="nav-item" onclick="window.openConfigModal()"><i class="fas fa-cog"></i> Configuraci贸n</button>
                    </div>
                </div>
            </aside>

            <main class="main-content" id="mainContentArea">
                <div id="dashboardView" class="view-container active">
                    <div class="widget-grid-top">
                        <div class="widget-card widget-quote">
                            <div class="quote-icon"><i class="fas fa-lightbulb"></i></div>
                            <div>
                                <div style="text-transform:uppercase; font-size:0.7rem; opacity:0.8; font-weight:700; margin-bottom:4px;">Pensamiento del d铆a</div>
                                <div class="quote-text" id="widgetQuote">"..."</div>
                            </div>
                        </div>
                        <div class="widget-card">
                            <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom: 5px;">
                                <div class="task-icon"><i class="fas fa-tasks"></i></div>
                                <div style="font-size:1.1rem; font-weight:800; color:var(--text-main);" id="widgetTaskCount">0/0</div>
                            </div>
                            <div style="font-size:0.7rem; color:var(--text-light); font-weight:600;">Tarea Cumplida</div>
                            <div class="task-progress-bg"><div class="task-progress-fill" id="widgetTaskBar"></div></div>
                        </div>
                    </div>
                    <div class="widget-grid-mid">
    <div class="widget-card widget-countdown">
        <div class="countdown-label">Pr贸ximo Hito</div>
        <div class="countdown-time" id="wdgCountTime">--</div>
        <div class="countdown-title" id="wdgCountTitle">Sin plazos pendientes</div>
    </div>
    <div class="widget-card widget-event">
        <div class="event-date" id="wdgEventDate">--/--</div>
        <div class="event-title" id="wdgEventTitle">Sin eventos pr贸ximos</div>
        <div style="font-size:0.8rem; color:var(--text-light); margin-top:5px;">Efem茅ride Escolar</div>
    </div>
    <div class="widget-card">
        <div style="font-weight:700; color:var(--text-light); margin-bottom:10px; font-size:0.8rem;">ENLACES RPIDOS</div>
        <div class="links-grid">
            <a href="ps://www.sige.cl" target="_blank" class="quick-link">
                <i class="fas fa-university" style="color:#2563eb"></i>
                <span>SIGE</span>
            </a>
            <a href="https://www.supereduc.cl" target="_blank" class="quick-link">
                <i class="fas fa-balance-scale" style="color:#dc2626"></i>
                <span>Super</span>
            </a>
            <a href="https://www.mineduc.cl" target="_blank" class="quick-link">
                <i class="fas fa-book" style="color:#059669"></i>
                <span>Mineduc</span>
            </a>
            <a href="https://script.google.com/macros/s/AKfycbyTjFhLaNC6y3F0LgyeFCQoAW8Q32nTVKKHhfec2tQOa4geWRF4Oc3ZX4YdyDVgsFRibw/exec" 
               target="_blank" class="quick-link">
                <i class="fas fa-users" style="color:#d97706"></i>
                <span>Comunidad</span>
            </a>
        </div>
    </div>
</div>

<h2 style="margin-bottom: 1rem;">Resumen General</h2>
<div class="dashboard-grid">
    <div class="card stat-card" style="border-left: 4px solid var(--primary);" onclick="window.switchView('cases');">
        <div class="stat-content">
            <h3 id="dashTotalCases">0</h3>
            <p>Casos Totales</p>
        </div>
        <i class="fas fa-folder" style="font-size:1.4rem; opacity:0.2;"></i>
    </div>
    <div class="card stat-card" style="border-left: 4px solid var(--danger);" onclick="window.switchView('cases')">
        <div class="stat-content">
            <h3 id="dashOpenCases">0</h3>
            <p>Casos Abiertos</p>
        </div>
        <i class="fas fa-exclamation-circle" style="font-size:1.4rem; opacity:0.2; color:var(--danger);"></i>
    </div>
    <div class="card stat-card" style="border-left: 4px solid var(--success);" onclick="window.switchView('list')">
        <div class="stat-content">
            <h3 id="dashActivities">0</h3>
            <p>Actividades</p>
        </div>
        <i class="fas fa-check-circle" style="font-size:1.4rem; opacity:0.2; color:var(--success);"></i>
    </div>
</div>
                    <div class="dashboard-row">
                        <div class="card">
                            <h3>Notas R谩pidas</h3>
                            <div class="sticky-notes-grid" id="stickyNotesContainer" style="margin-top:10px;"></div>
                        </div>
                        <div class="card"><h3>Pr贸ximos Eventos</h3><div id="upcomingEventsList" style="margin-top: 1rem; display: flex; flex-direction: column; gap: 10px;"></div></div>
                    </div>
                </div>

                <div id="casesView" class="view-container">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1.5rem;">
                        <h2>Bit谩cora</h2>
                        <div style="display:flex; gap:10px;"><input type="text" id="caseSearch" class="form-control" placeholder="Buscar..." style="width: 200px; margin:0;"><button class="btn btn-primary" onclick="window.openCaseModal()"><i class="fas fa-plus"></i> Nuevo</button></div>
                    </div>
                    <div class="card" style="padding:0; overflow:hidden; overflow-x: auto;"><table class="cases-table"><thead><tr><th>Fecha</th><th>Estudiante</th><th>Curso</th><th>Tipo</th><th>Estado</th><th></th></tr></thead><tbody id="casesTableBody"></tbody></table></div>
                </div>

                <div id="calendarView" class="view-container">
                    <div style="display:flex; justify-content:space-between; margin-bottom:1rem;">
                        <h2 id="calMonthYear">Calendario</h2>
                        <div><button class="btn btn-secondary" onclick="window.changeMonth(-1)"><</button><button class="btn btn-secondary" onclick="window.resetDate()">Hoy</button><button class="btn btn-secondary" onclick="window.changeMonth(1)">></button></div>
                    </div>
                    <div class="calendar-header" style="display:grid; grid-template-columns: repeat(7, 1fr); text-align:center; padding:10px;"><div>Dom</div><div>Lun</div><div>Mar</div><div>Mi茅</div><div>Jue</div><div>Vie</div><div>S谩b</div></div>
                    <div class="calendar-grid" id="calendarGrid"></div>
                </div>

                <div id="ganttView" class="view-container">
                    <h2 style="margin-bottom:1rem;">Carta Gantt (Mensual)</h2>
                    <div class="gantt-wrapper" id="ganttContainer"></div>
                </div>
                
                <div id="listView" class="view-container">
                    <h2 style="margin-bottom:1rem;">Lista de Actividades</h2>
                    <div class="card" id="activitiesListContainer" style="padding:0; overflow:hidden;"></div>
                </div>

                <div id="scheduleView" class="view-container">
                    <h2 style="margin-bottom:1.5rem;">Horario de Clases Semanal</h2>
                    <div class="schedule-container" style="overflow-x:auto; position:relative; -webkit-overflow-scrolling: touch;">
                        <table class="schedule-table">
                            <thead>
                                <tr>
                                    <th style="min-width:130px;">Hora</th>
                                    <th>Lunes</th>
                                    <th>Martes</th>
                                    <th>Mi茅rcoles</th>
                                    <th>Jueves</th>
                                    <th>Viernes</th>
                                    </tr>
                            </thead>
                            <tbody id="scheduleBodyViewer">
                                </tbody>
                        </table>
                    </div>
                    <div style="margin-top:1rem; font-size:0.8rem; color:var(--text-light); text-align:center;">
                        <i class="fas fa-info-circle"></i> Para editar el horario, ve a Configuraci贸n.
                    </div>
                </div>
            </main>
        </div>
        
        <button class="fab" onclick="window.openActivityModal()" title="Crear Actividad"><i class="fas fa-plus"></i></button>
    </div>

    <div id="caseModal" class="modal-overlay">
        <div class="modal-container">
            <div class="modal-header">Incidencia <button style="background:none; border:none; font-size:1.5rem;" onclick="window.closeModals()">&times;</button></div>
            <div class="modal-body">
                <form id="caseForm">
                    <input type="hidden" id="caseId">
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                        <div><label class="form-label">Fecha</label><input type="text" id="caseDate" class="form-control" required></div>
                        <div><label class="form-label">Estado</label><select id="caseStatus" class="form-control"><option value="open"> Abierto</option><option value="progress"> Seguimiento</option><option value="closed"> Cerrado</option></select></div>
                    </div>
                    <div style="display:grid; grid-template-columns: 2fr 1fr; gap:15px;">
                        <div><label class="form-label">Estudiante</label><input type="text" id="caseStudent" class="form-control" required></div>
                        <div><label class="form-label">Curso</label><input type="text" id="caseGrade" class="form-control"></div>
                    </div>
                    <div><label class="form-label">Tipo</label><select id="caseType" class="form-control"><option value="leve">Leve</option><option value="grave">Grave</option><option value="conflicto">Conflicto</option><option value="bullying">Acoso</option></select></div>
                    <div><label class="form-label">Descripci贸n</label><textarea id="caseDesc" class="form-control" rows="2"></textarea></div>
                    <div><label class="form-label">Acci贸n a seguir</label><textarea id="caseAction" class="form-control" rows="2"></textarea></div>
                    <button type="submit" class="btn btn-primary" style="margin-top:10px; width:100%">Guardar</button>
                </form>
            </div>
        </div>
    </div>

    <div id="activityModal" class="modal-overlay">
        <div class="modal-container">
            <div class="modal-header">Actividad <button style="background:none; border:none; font-size:1.5rem;" onclick="window.closeModals()">&times;</button></div>
            <div class="modal-body">
                <form id="activityForm">
                    <input type="hidden" id="actId">
                    <div><label class="form-label">T铆tulo</label><input type="text" id="actTitle" class="form-control" required></div>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                        <div><label class="form-label">Inicio</label><input type="text" id="actDate" class="form-control" required></div>
                        <div><label class="form-label">Fin</label><input type="text" id="actEndDate" class="form-control"></div>
                    </div>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                        <div><label class="form-label">Hora</label><input type="text" id="actTime" class="form-control"></div>
                        <div><label class="form-label">Tipo</label><select id="actType" class="form-control"><option value="actividad">Actividad</option><option value="reunion">Reuni贸n</option><option value="entrevista">Entrevista</option><option value="plazo">Plazo</option><option value="efemeride">Efem茅ride</option></select></div>
                    </div>
                    <div><label class="form-label"> Alarma</label>
                        <select id="actAlarm" class="form-control">
                            <option value="0">Sin alarma</option>
                            <option value="1">1 minuto antes</option>
                            <option value="5">5 minutos antes</option>
                            <option value="15">15 minutos antes</option>
                            <option value="60">1 hora antes</option>
                        </select>
                    </div>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                        <div><label class="form-label">Color</label><input type="color" id="actColor" class="form-control" style="height:45px;"></div>
                    </div>
                    <div><label class="form-label">Descripci贸n</label><textarea id="actDesc" class="form-control" rows="2"></textarea></div>
                    <div style="display:flex; justify-content:space-between; margin-top:20px;">
                         <button type="button" id="btnDeleteAct" class="btn btn-danger" onclick="window.deleteActivity()" style="display:none;">Eliminar</button>
                        <button type="submit" class="btn btn-primary">Guardar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="configModal" class="modal-overlay">
        <div class="modal-container">
            <div class="modal-header">Configuraci贸n <button style="background:none; border:none; font-size:1.5rem;" onclick="window.closeModals()">&times;</button></div>
            <div class="modal-body">
                
                <h3><i class="fas fa-calendar-alt"></i> Editor de Horario</h3>
                <div style="margin-bottom:20px; border:1px solid var(--border); padding:10px; border-radius:12px; background:rgba(99,102,241,0.05);">
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:10px;">
                        <div><label class="form-label">Per铆odo</label><input type="text" id="schedulePeriod" class="form-control" placeholder="Ej: 2024 - Sem 1"></div>
                        <div><label class="form-label">Materia Principal</label><input type="text" id="scheduleSubject" class="form-control" placeholder="Ej: Lenguaje"></div>
                    </div>
                    
                    <div class="schedule-actions">
                        <button class="btn btn-primary" onclick="window.saveScheduleConfig()"><i class="fas fa-save"></i> Guardar</button>
                        <button class="btn btn-secondary" onclick="window.addScheduleHour()"><i class="fas fa-plus"></i> Hora</button>
                        <button class="btn btn-secondary" onclick="window.duplicateLastHour()"><i class="fas fa-copy"></i> Duplicar</button>
                        <button class="btn btn-danger" onclick="window.removeLastHour()"><i class="fas fa-trash"></i> Eliminar</button>
                        <button class="btn btn-secondary" onclick="window.clearAllHours()"><i class="fas fa-broom"></i> Limpiar</button>
                        <button class="btn btn-primary" onclick="window.openAddClassModal()"><i class="fas fa-plus-circle"></i> Materia</button>
                        <button class="btn btn-secondary" onclick="window.showClassPicker()"><i class="fas fa-palette"></i> Selector</button>
                    </div>
                    
                    <div class="selection-info" id="selectionInfo" style="display:none;">
                        <div><span id="selectedCount">0</span> seleccionadas <span style="font-size:0.8rem; color:var(--text-light);">(Ctrl+Click m煤ltiple)</span></div>
                        <div style="display:flex; gap:8px;">
                            <button class="btn btn-danger" onclick="window.clearSelectedCells()"><i class="fas fa-trash"></i> Vaciar</button>
                            <button class="btn btn-secondary" onclick="window.clearSelection()"><i class="fas fa-times"></i> Cancelar</button>
                        </div>
                    </div>
                    
                    <div style="margin-top:10px; display:flex; flex-wrap:wrap; gap:8px; align-items:center; margin-bottom:10px;">
                        <span style="font-weight:600; color:var(--text-light);">Modo:</span>
                        <div style="display:flex; background:var(--bg-body); border-radius:8px; padding:2px;">
                            <button id="modeSingle" class="btn" style="background:var(--primary); color:white; padding:6px 12px; border-radius:6px;">Simple</button>
                            <button id="modeMultiple" class="btn" style="background:transparent; padding:6px 12px; border-radius:6px;" onclick="window.toggleSelectionMode(true)">M煤ltiple</button>
                        </div>
                    </div>

                    <div id="scheduleEditorContainer" class="schedule-editor-mode" style="overflow-x:auto; -webkit-overflow-scrolling: touch; background:white; border-radius:12px; border:1px solid var(--border);">
                        <div id="classPicker" class="class-picker"></div>
                        <table class="schedule-table">
                            <thead>
                                <tr>
                                    <th style="min-width:130px;">Hora</th>
                                    <th>Lun</th><th>Mar</th><th>Mi茅</th><th>Jue</th><th>Vie</th>
                                </tr>
                            </thead>
                            <tbody id="scheduleBodyEditor"></tbody>
                        </table>
                    </div>
                    
                    <div style="margin-top:1rem;">
                        <label class="form-label">Materias R谩pidas</label>
                        <div id="quickClassesContainer" style="display:flex; flex-wrap:wrap; gap:10px; align-items:center;"></div>
                    </div>
                </div>

                <hr style="margin: 20px 0; border: 0; border-top: 1px solid var(--border);">
                
                <h3><i class="fas fa-id-card"></i> Personalizaci贸n</h3>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:15px;">
                    <div><label class="form-label">Foto Perfil</label><input type="file" onchange="window.handleProfileUpload(this)" accept="image/*" class="form-control"></div>
                    <div><label class="form-label">Logo Institucional</label><input type="file" onchange="window.handleLogoUpload(this)" accept="image/*" class="form-control"></div>
                </div>
                <div style="margin-bottom:20px;">
                    <label class="form-label">Nombre/Subt铆tulo</label>
                    <input type="text" id="configSubtitle" class="form-control" placeholder="Ej: Encargado de Convivencia" onchange="window.saveSubtitle(this.value)">
                </div>
                <button class="btn btn-danger" onclick="window.clearCustomImages()" style="width:100%; margin-bottom:20px;">Borrar Im谩genes</button>

                <hr style="margin: 20px 0; border: 0; border-top: 1px solid var(--border);">
                
                <h3><i class="fas fa-bell"></i> Alarmas</h3>
                <div style="margin-bottom:20px;">
                    <select id="configAlarmType" class="form-control" onchange="window.saveConfigAlarm(this.value)">
                        <option value="nuclear">锔 Nuclear (Intensa)</option>
                        <option value="gentle"> Suave (Flotante)</option>
                        <option value="quick"> R谩pida (Sutil)</option>
                    </select>
                </div>
                
                <hr style="margin: 20px 0; border: 0; border-top: 1px solid var(--border);">

                <h3><i class="fas fa-cloud"></i> Sincronizaci贸n</h3>
                <div style="background: rgba(99, 102, 241, 0.1); padding: 15px; border-radius: 8px; border: 1px solid var(--primary); margin-bottom: 20px;">
                    <div style="margin-bottom:15px;">
                        <label class="form-label" style="font-weight:700;">1. Mis Credenciales</label>
                        <input type="password" id="githubToken" class="form-control" placeholder="Pegar token ghp_..." onchange="window.saveToken(this.value)">
                    </div>
                    <div style="background:rgba(255,255,255,0.5); padding:10px; border-radius:8px; margin-bottom:15px;">
                        <label class="form-label" style="color:var(--primary); font-weight:800; font-size:0.8rem;">TU ID DE NUBE</label>
                        <div style="display:flex; gap:5px;">
                            <code id="currentGistIdDisplay" style="flex:1; background:#fff; padding:5px; border:1px solid #ccc; border-radius:4px; font-size:0.8rem; overflow:hidden; text-overflow:ellipsis;">-</code>
                            <button class="btn btn-secondary" onclick="navigator.clipboard.writeText(document.getElementById('currentGistIdDisplay').textContent); alert('Copiado!')"><i class="fas fa-copy"></i></button>
                        </div>
                    </div>
                    <div style="margin-top:15px; border-top:1px dashed var(--primary); padding-top:10px;">
                        <label class="form-label" style="font-weight:700;">2. Vincular Dispositivo</label>
                        <input type="text" id="manualGistId" class="form-control" placeholder="Pegar ID de otro dispositivo...">
                        <button class="btn btn-primary" onclick="window.manualSync(true)" style="width:100%"><i class="fas fa-link"></i> Forzar Conexi贸n</button>
                    </div>
                    <div style="margin-top:10px; font-size:0.75rem; text-align:center;">Estado: <span id="cloudStatusText">Desconectado</span></div>
                </div>

                <h3><i class="fas fa-database"></i> Gesti贸n de Datos</h3>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:20px;">
                    <button class="btn btn-secondary" onclick="window.exportToCloud()"><i class="fas fa-download"></i> Backup</button>
                    <button class="btn btn-secondary" onclick="window.importFromCloud()"><i class="fas fa-upload"></i> Restaurar</button>
                </div>
                <button class="btn btn-secondary" onclick="window.removeDuplicates()" style="width:100%; margin-bottom:20px;"><i class="fas fa-broom"></i> Eliminar Duplicados</button>

                <h3><i class="fas fa-image"></i> Fondos</h3>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:10px;">
                    <div><label class="form-label">Dashboard</label><input type="file" onchange="window.handleBgUpload(this, 'dashboard')" accept="image/*" class="form-control"></div>
                    <div><label class="form-label">Bit谩cora</label><input type="file" onchange="window.handleBgUpload(this, 'cases')" accept="image/*" class="form-control"></div>
                </div>
                <button class="btn btn-danger" onclick="window.clearBackgrounds()" style="width:100%">Quitar Fondos</button>
                
                <div style="text-align: right; margin-top:20px;">
                    <button class="btn btn-primary" onclick="window.closeModals()">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://npmcdn.com/flatpickr/dist/l10n/es.js"></script>

    <script type="module">
    // --- VARIABLES GLOBALES ---
    const CLOUD_FILENAME = 'sgi_convivencia_db.json';
    let GITHUB_TOKEN = localStorage.getItem('sgi_github_token') || '';
    let GIST_ID = localStorage.getItem('sgi_gist_id') || null;

    let db = { 
        activities: [], 
        cases: [], 
        notes: [], 
        config: { primary: '#6366f1', sidebar: '#1e293b', backgrounds: {}, alarmType: 'nuclear', profilePic: null, logo: null, subtitle: '' }, 
        lastUpdated: 0, 
        version: "9.3" 
    };
    
    let currentDate = new Date();
    let currentViewName = 'dashboard';
    let saveTimeout;
    let flatpickrInstances = {};
    let selectedActivities = new Set(); 
    let selectedCells = new Set();
    let isMultipleSelection = false;
    let isCtrlPressed = false;
    let quickClassToSet = null;

    // --- HORARIO DE CLASES SEMANAL (SABADO ELIMINADO) ---
    const defaultSchedule = {
        period: "2024 - Semestre 1",
        subject: "Lenguaje y Comunicaci贸n",
        hours: [
            { time: "08:00 - 08:45", mon: "Matem谩ticas", tue: "Lenguaje", wed: "Historia", thu: "Ciencias", fri: "Ingl茅s" },
            { time: "08:45 - 09:30", mon: "Matem谩ticas", tue: "Lenguaje", wed: "Historia", thu: "Ciencias", fri: "Ingl茅s" },
            { time: "09:30 - 10:15", mon: "Educaci贸n F铆sica", tue: "Artes", wed: "Matem谩ticas", thu: "Lenguaje", fri: "Taller" },
            { time: "10:15 - 10:45", mon: "RECREO", tue: "RECREO", wed: "RECREO", thu: "RECREO", fri: "RECREO" },
            { time: "10:45 - 11:30", mon: "Ciencias", tue: "Matem谩ticas", wed: "Lenguaje", thu: "Historia", fri: "M煤sica" },
            { time: "11:30 - 12:15", mon: "Ciencias", tue: "Matem谩ticas", wed: "Lenguaje", thu: "Historia", fri: "M煤sica" },
            { time: "12:15 - 13:30", mon: "ALMUERZO", tue: "ALMUERZO", wed: "ALMUERZO", thu: "ALMUERZO", fri: "ALMUERZO" },
            { time: "13:30 - 14:15", mon: "Taller", tue: "Ciencias", wed: "Artes", thu: "Matem谩ticas", fri: "Educaci贸n F铆sica" },
            { time: "14:15 - 15:00", mon: "Taller", tue: "Ciencias", wed: "Artes", thu: "Matem谩ticas", fri: "Educaci贸n F铆sica" }
        ]
    };

    if (!db.customClasses) {
        db.customClasses = [
            { name: "Matem谩ticas", color: "#3b82f6" },
            { name: "Lenguaje", color: "#6366f1" },
            { name: "Ciencias", color: "#10b981" },
            { name: "Historia", color: "#f59e0b" },
            { name: "Ingl茅s", color: "#ef4444" },
            { name: "Artes", color: "#8b5cf6" },
            { name: "M煤sica", color: "#ec4899" },
            { name: "Educaci贸n F铆sica", color: "#14b8a6" },
            { name: "Tecnolog铆a", color: "#64748b" },
            { name: "Taller", color: "#10b981" },
            { name: "Evaluaci贸n", color: "#f59e0b" },
            { name: "Reuni贸n", color: "#ef4444" },
            { name: "RECREO", color: "#f1f5f9", textColor: "var(--text-main)" },
            { name: "ALMUERZO", color: "#f1f5f9", textColor: "var(--text-main)" }
        ];
    }

    // --- WIDGETS LOGIC ---
    const dailyQuotes = [
        "La educaci贸n es el arma m谩s poderosa para cambiar el mundo.",
        "Educar no es llenar un cubo, sino encender un fuego.",
        "El arte de ense帽ar es el arte de asistir al descubrimiento.",
        "La paciencia es la fortaleza del d茅bil y la impaciencia la debilidad del fuerte.",
        "Aprender es la 煤nica cosa que la mente nunca se cansa de hacer.",
        "Lo que se aprende con placer nunca se olvida.",
        "Ense帽ar es aprender dos veces.",
        "La inteligencia es la capacidad de adaptarse al cambio.",
        "La educaci贸n genera confianza. La confianza genera esperanza.",
        "Un ni帽o, un profesor, un libro y una pluma pueden cambiar al mundo."
    ];

    function updateWidgets() {
        if (!db || !db.activities) return; 
        try {
            const dayOfMonth = new Date().getDate();
            const qEl = document.getElementById('widgetQuote');
            if(qEl) qEl.textContent = `"${dailyQuotes[dayOfMonth % dailyQuotes.length]}"`;
            const now = new Date();
            const todayStr = now.toISOString().split('T')[0];
            const nowMinutes = now.getHours() * 60 + now.getMinutes();
            const todayActs = db.activities.filter(a => a.date === todayStr);
            const total = todayActs.length;
            const completed = todayActs.filter(a => {
                if(!a.time) return false; 
                try { const [h,m] = a.time.split(':').map(Number); return (h*60 + m) <= nowMinutes; } catch(e) { return false; }
            }).length;
            const taskCountEl = document.getElementById('widgetTaskCount');
            const taskBarEl = document.getElementById('widgetTaskBar');
            if(taskCountEl) taskCountEl.textContent = `${completed}/${total}`;
            if(taskBarEl) taskBarEl.style.width = total===0 ? '0%' : `${(completed/total)*100}%`;
            const countTimeEl = document.getElementById('wdgCountTime');
            const countTitleEl = document.getElementById('wdgCountTitle');
            if(countTimeEl && countTitleEl) {
                const upcomingPlazos = db.activities.filter(a => a.type === 'plazo' && a.date >= todayStr).sort((a,b) => (a.date || '').localeCompare(b.date || ''));
                if (upcomingPlazos.length > 0) {
                    const next = upcomingPlazos[0];
                    const diffTime = Math.abs(new Date(next.date) - new Date(todayStr));
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
                    countTimeEl.textContent = `${diffDays} d铆as`;
                    countTitleEl.textContent = next.title || 'Sin t铆tulo';
                } else { countTimeEl.textContent = "--"; countTitleEl.textContent = "Sin plazos pr贸ximos"; }
            }
            const evtDateEl = document.getElementById('wdgEventDate');
            const evtTitleEl = document.getElementById('wdgEventTitle');
            if(evtDateEl && evtTitleEl) {
                const upcomingEvents = db.activities.filter(a => a.type === 'efemeride' && a.date >= todayStr).sort((a,b) => (a.date || '').localeCompare(b.date || ''));
                if (upcomingEvents.length > 0) { const evt = upcomingEvents[0]; evtDateEl.textContent = window.formatDate(evt.date); evtTitleEl.textContent = evt.title || 'Evento'; } else { evtTitleEl.textContent = "Sin efem茅rides"; }
            }
        } catch(err) { console.warn("Widget error ignored:", err); }
    }

    function checkAlarms() {
        if (!db.activities) return;
        const now = new Date();
        const currentTime = now.getHours() * 60 + now.getMinutes();
        const currentDateStr = now.toISOString().split('T')[0];
        db.activities.forEach(act => {
            if (act.date === currentDateStr && act.time && act.alarm > 0) {
                try {
                    const [h, m] = act.time.split(':').map(Number);
                    const eventTime = h * 60 + m;
                    const alarmTime = eventTime - act.alarm;
                    if (currentTime === alarmTime && !act.alarmTriggered) { triggerAlarm(act); act.alarmTriggered = true; }
                } catch(e){}
            }
        });
    }

    function triggerAlarm(act) {
        const modal = document.getElementById('alarmModal');
        const desc = document.getElementById('alarmDesc');
        const title = document.getElementById('alarmTitle');
        if(!modal) return;
        modal.className = 'alarm-modal active';
        const type = (db.config && db.config.alarmType) ? db.config.alarmType : 'nuclear';
        modal.classList.add(`alarm-${type}`);
        title.textContent = "隆Recordatorio!";
        desc.textContent = `Evento: "${act.title}" comienza en ${act.alarm} minutos.`;
    }
    window.stopAlarm = function() { const m = document.getElementById('alarmModal'); if(m) m.classList.remove('active'); };
    window.saveConfigAlarm = function(val) { if(!db.config) db.config={}; db.config.alarmType = val; window.saveData(); };

    window.manualSync = async function(isForced = false) {
        const icon = document.getElementById('syncIcon');
        if(icon) icon.classList.add('fa-spin');
        if(isForced) {
            const manualId = document.getElementById('manualGistId').value.trim();
            if(manualId) { GIST_ID = manualId; localStorage.setItem('sgi_gist_id', GIST_ID); db.lastUpdated = 0; }
        }
        await CloudManager.sync(false); 
        if(icon) icon.classList.remove('fa-spin');
    };

    const CloudManager = {
        async findGist() {
            if (!GITHUB_TOKEN) return null;
            try {
                const response = await fetch('https://api.github.com/gists', { headers: { 'Authorization': `token ${GITHUB_TOKEN}` } });
                const gists = await response.json();
                const found = gists.find(g => g.files && g.files[CLOUD_FILENAME]);
                return found ? found.id : null;
            } catch (e) { console.error(e); return null; }
        },
        async createGist() {
            if (!GITHUB_TOKEN) return;
            updateStatus('syncing', 'Creando...');
            try {
                const response = await fetch('https://api.github.com/gists', {
                    method: 'POST',
                    headers: { 'Authorization': `token ${GITHUB_TOKEN}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ description: "SGI DB", public: false, files: { [CLOUD_FILENAME]: { content: JSON.stringify(db) } } })
                });
                const data = await response.json();
                GIST_ID = data.id; localStorage.setItem('sgi_gist_id', GIST_ID);
                updateStatus('online', 'Nube OK');
                document.getElementById('currentGistIdDisplay').textContent = GIST_ID;
            } catch (e) { updateStatus('offline', 'Error'); }
        },
        async sync(silent = true) {
            if (!GITHUB_TOKEN) return;
            if(!silent) updateStatus('syncing', 'Sync...');
            if (!GIST_ID) { GIST_ID = await this.findGist(); if(!GIST_ID){ await this.createGist(); return; } localStorage.setItem('sgi_gist_id', GIST_ID); }
            const disp = document.getElementById('currentGistIdDisplay');
            if(disp) disp.textContent = GIST_ID;
            try {
                const response = await fetch(`https://api.github.com/gists/${GIST_ID}`, { headers: { 'Authorization': `token ${GITHUB_TOKEN}` } });
                const gistData = await response.json();
                if(gistData.files && gistData.files[CLOUD_FILENAME]) {
                    const cloudDB = JSON.parse(gistData.files[CLOUD_FILENAME].content);
                    if (cloudDB.lastUpdated > (db.lastUpdated || 0)) {
                        console.log("Downloading new data...");
                        db = ensureIntegrity(cloudDB); saveLocalData(false); refreshAllViews(); 
                        if(!silent) showNotification("Datos actualizados", "success");
                    } else if (db.lastUpdated > (cloudDB.lastUpdated || 0)) { await this.upload(); }
                    updateStatus('online', 'Sincronizado');
                    const st = document.getElementById('cloudStatusText'); if(st) { st.textContent = "Conectado"; st.style.color = "var(--success)"; }
                }
            } catch (e) { if(!silent) updateStatus('offline', 'Error Sync'); }
        },
        async upload() {
            if (!GITHUB_TOKEN || !GIST_ID) return;
            try {
                await fetch(`https://api.github.com/gists/${GIST_ID}`, {
                    method: 'PATCH',
                    headers: { 'Authorization': `token ${GITHUB_TOKEN}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ files: { [CLOUD_FILENAME]: { content: JSON.stringify(db) } } })
                });
                updateStatus('online', 'Guardado');
            } catch (e) { updateStatus('offline', 'Error Subida'); }
        }
    };

    function ensureIntegrity(data) {
        if (!data || typeof data !== 'object') data = {};
        if (!Array.isArray(data.activities)) data.activities = [];
        if (!Array.isArray(data.cases)) data.cases = [];
        if (!Array.isArray(data.notes)) data.notes = [];
        if (!data.config) data.config = { primary: '#6366f1', backgrounds: {}, alarmType: 'nuclear', profilePic: null, logo: null, subtitle: '' };
        if (!data.config.backgrounds) data.config.backgrounds = {};
        if (!data.lastUpdated) data.lastUpdated = Date.now();
        if (!data.customClasses) data.customClasses = [];
        if (!data.schedule) data.schedule = null;
        return data;
    }
    function updateStatus(status, text) {
        const el = document.getElementById('connectionStatus'); 
        if(!el) return;
        el.className = `connection-indicator status-${status}`;
        let icon = status === 'online' ? 'wifi' : (status === 'syncing' ? 'sync fa-spin' : 'wifi-slash');
        el.innerHTML = `<i class="fas fa-${icon} status-icon"></i> <span style="display:none; @media(min-width:600px){display:inline;}">${text}</span>`;
    }
    window.formatDate = function(d) { 
        if(!d) return ''; 
        try { if (d.includes('/')) return d; const parts = d.split('-'); if (parts.length === 3) return `${parts[2]}/${parts[1]}/${parts[0].slice(-2)}`; return d; } catch { return d; }
    };
    window.showNotification = function(t, type='info', duration=3000) { 
        const n = document.getElementById('notification'); 
        const txt = document.getElementById('notifText');
        if(n && txt) { txt.textContent = t; n.className = `notification show ${type}`; setTimeout(() => n.classList.remove('show'), duration); }
    };

    function saveLocalData(triggerCloud = true) {
        localStorage.setItem('sgi_data', JSON.stringify(db));
        if (triggerCloud && GITHUB_TOKEN) { clearTimeout(saveTimeout); saveTimeout = setTimeout(() => { CloudManager.upload(); }, 1000); }
    }
    window.saveData = function() { db.lastUpdated = Date.now(); saveLocalData(true); refreshAllViews(); };

    window.handleBgUpload = function(input, viewName) {
        const file = input.files[0]; if(!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            if(!db.config) db.config={}; if(!db.config.backgrounds) db.config.backgrounds={};
            db.config.backgrounds[viewName] = e.target.result;
            window.saveData(); showNotification("Fondo actualizado", "success");
        };
        reader.readAsDataURL(file);
    };
    window.handleProfileUpload = function(input) {
        const file = input.files[0]; if(!file) return;
        const reader = new FileReader();
        reader.onload = function(e) { if(!db.config) db.config={}; db.config.profilePic = e.target.result; window.saveData(); showNotification("Foto perfil actualizada", "success"); };
        reader.readAsDataURL(file);
    };
    window.handleLogoUpload = function(input) {
        const file = input.files[0]; if(!file) return;
        const reader = new FileReader();
        reader.onload = function(e) { if(!db.config) db.config={}; db.config.logo = e.target.result; window.saveData(); showNotification("Logo actualizado", "success"); };
        reader.readAsDataURL(file);
    };
    window.saveSubtitle = function(val) { if(!db.config) db.config={}; db.config.subtitle = val; window.saveData(); };
    window.clearCustomImages = function() { if(db.config) { db.config.profilePic = null; db.config.logo = null; db.config.subtitle = ''; document.getElementById('configSubtitle').value = ''; } window.saveData(); showNotification("Im谩genes borradas", "info"); };
    window.clearBackgrounds = function() { if(db.config) db.config.backgrounds = {}; window.saveData(); };
    
    function applyHeaderStyles() {
        const icon = document.getElementById('defaultIcon'); const img = document.getElementById('profilePicImg');
        if(db.config && db.config.profilePic) { icon.style.display = 'none'; img.style.display = 'block'; img.src = db.config.profilePic; } else { icon.style.display = 'block'; img.style.display = 'none'; }
        const logo = document.getElementById('headerLogoCenter');
        if(db.config && db.config.logo) { logo.src = db.config.logo; logo.style.display = 'block'; } else { logo.style.display = 'none'; }
        const sub = document.getElementById('appSubtitleDisplay'); if(sub) sub.textContent = (db.config && db.config.subtitle) ? db.config.subtitle : '';
    }

    function applyBackgrounds() {
        const area = document.getElementById('mainContentArea'); if(!area) return;
        area.style.backgroundImage = 'none';
        if(db.config && db.config.backgrounds && db.config.backgrounds[currentViewName]) { area.style.backgroundImage = `url('${db.config.backgrounds[currentViewName]}')`; }
    }
    
    window.removeDuplicates = function() {
        if(!db.activities) return;
        const initial = db.activities.length;
        const unique = new Map();
        db.activities.forEach(a => unique.set(a.title+a.date+a.time, a));
        db.activities = Array.from(unique.values());
        window.saveData(); showNotification(`Eliminados ${initial - db.activities.length} duplicados`, "info");
    };
    window.exportToCloud = function() { const blob = new Blob([JSON.stringify(db, null, 2)], {type: 'application/json'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `sgi_backup.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); };
    window.importFromCloud = function() {
        const input = document.createElement('input'); input.type = 'file'; input.accept = '.json';
        input.onchange = e => {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = event => {
                try {
                    const imported = JSON.parse(event.target.result); db = ensureIntegrity(imported); window.saveData(); showNotification("Datos restaurados", "success");
                } catch(err) { showNotification("Error en archivo", "danger"); }
            };
            reader.readAsText(file);
        };
        input.click();
    };

    // --- LGICA DE SELECCIN ---
    window.toggleSelection = function(id) { 
        if(selectedActivities.has(id)) selectedActivities.delete(id); 
        else selectedActivities.add(id); 
        
        // Renderizado parcial r谩pido para feedback visual
        window.renderActivitiesList(); 
    };
    
    window.clearSelection = function() { selectedActivities.clear(); updateBulkBar(); refreshAllViews(); };
    function updateBulkBar() {
        const bar = document.getElementById('bulkActionBar'); 
        const count = document.getElementById('bulkCount');
        if(count) count.textContent = selectedActivities.size;
        if(bar) { if(selectedActivities.size > 0) bar.classList.add('visible'); else bar.classList.remove('visible'); }
    }
    window.shareSelected = function(method) {
        let text = " *Resumen de Actividades*\n\n";
        selectedActivities.forEach(id => {
            const act = db.activities.find(a => a.id == id);
            if(act) text += ` *${act.title}*\n   Fecha: ${window.formatDate(act.date)} ${act.time||''}\n   Detalle: ${act.description||'-'}\n\n`;
        });
        const encoded = encodeURIComponent(text);
        if(method === 'whatsapp') window.open(`https://wa.me/?text=${encoded}`, '_blank');
        if(method === 'email') window.open(`mailto:?subject=Resumen Actividades&body=${encoded}`, '_blank');
        window.clearSelection();
    };

    // --- HORARIO DE CLASES FUNCTIONS (SEPARACIN VIEWER / EDITOR) ---
    function getClassColor(className) {
        if (!className) return { bg: "#f8fafc", text: "var(--text-main)" };
        const lower = className.toLowerCase();
        if (lower.includes("recreo") || lower.includes("almuerzo")) return { bg: "#f1f5f9", text: "var(--text-main)" };
        for (const qc of db.customClasses) {
            if (lower.includes(qc.name.toLowerCase())) return { bg: qc.color || "#4f46e5", text: qc.textColor || "white" };
        }
        return { bg: "#4f46e5", text: "white" };
    }

    window.toggleSelectionMode = function(multiple) {
        isMultipleSelection = multiple;
        const singleBtn = document.getElementById('modeSingle');
        const multipleBtn = document.getElementById('modeMultiple');
        if (multiple) {
            singleBtn.style.background = 'transparent'; singleBtn.style.color = 'var(--text-main)';
            multipleBtn.style.background = 'var(--primary)'; multipleBtn.style.color = 'white';
            showNotification("Modo m煤ltiple activado", "info", 2000);
        } else {
            singleBtn.style.background = 'var(--primary)'; singleBtn.style.color = 'white';
            multipleBtn.style.background = 'transparent'; multipleBtn.style.color = 'var(--text-main)';
            selectedCells.clear(); updateSelectionInfo();
        }
    };

    // Renderiza una tabla de horario (gen茅rica) en un target espec铆fico
    // isEditing = true agrega inputs y eventos
    window.renderScheduleGeneric = function(targetBodyId, isEditing) {
        const tbody = document.getElementById(targetBodyId);
        if (!tbody) return;
        tbody.innerHTML = '';
        if(isEditing) selectedCells.clear();
        
        let scheduleData = db.schedule || defaultSchedule;
        
        if(isEditing) {
            const periodInput = document.getElementById('schedulePeriod');
            const subjectInput = document.getElementById('scheduleSubject');
            if (periodInput) periodInput.value = scheduleData.period || defaultSchedule.period;
            if (subjectInput) subjectInput.value = scheduleData.subject || defaultSchedule.subject;
        }
        
        scheduleData.hours.forEach((hour, hourIndex) => {
            const row = document.createElement('tr');
            row.style.position = 'relative';
            
            // HORA CELL
            const timeCell = document.createElement('td');
            timeCell.style.padding = '12px'; timeCell.style.textAlign = 'center'; timeCell.style.background = 'var(--bg-body)';
            
            if (isEditing) {
                const timeInput = document.createElement('input');
                timeInput.type = 'text'; timeInput.className = 'time-edit-input'; timeInput.value = hour.time;
                timeInput.onchange = function() { scheduleData.hours[hourIndex].time = this.value; window.saveScheduleData(scheduleData); };
                timeCell.appendChild(timeInput);
                const hourControls = document.createElement('div');
                hourControls.className = 'hour-controls';
                hourControls.innerHTML = `
                    <button onclick="window.moveHourUp(${hourIndex})" title="Subir"><i class="fas fa-arrow-up"></i></button>
                    <button onclick="window.moveHourDown(${hourIndex})" title="Bajar"><i class="fas fa-arrow-down"></i></button>
                    <button onclick="window.deleteHour(${hourIndex})" title="Eliminar" style="color:var(--danger);"><i class="fas fa-trash"></i></button>
                `;
                timeCell.appendChild(hourControls);
            } else {
                timeCell.textContent = hour.time;
            }
            row.appendChild(timeCell);
            
            // DAYS CELLS (SIN SABADO)
            const days = ['mon', 'tue', 'wed', 'thu', 'fri'];
            days.forEach((day, dayIndex) => {
                const cell = document.createElement('td');
                cell.style.padding = '12px'; cell.style.textAlign = 'center'; cell.style.position = 'relative'; cell.style.minWidth = '120px';
                cell.dataset.hourIndex = hourIndex; cell.dataset.day = day;
                
                const className = hour[day] || '';
                cell.textContent = className;
                const colors = getClassColor(className);
                cell.style.backgroundColor = colors.bg; cell.style.color = colors.text; cell.style.fontWeight = className ? '500' : 'normal';
                
                if (isEditing) {
                    cell.onclick = function(e) {
                        const cellId = `${hourIndex}-${day}`;
                        if (isMultipleSelection || e.ctrlKey || e.metaKey) {
                            if (selectedCells.has(cellId)) { selectedCells.delete(cellId); this.classList.remove('selected'); } 
                            else { selectedCells.add(cellId); this.classList.add('selected'); }
                        } else {
                            selectedCells.clear();
                            document.querySelectorAll('.schedule-table td.selected').forEach(td => td.classList.remove('selected'));
                            if (quickClassToSet) {
                                this.textContent = quickClassToSet;
                                const newColors = getClassColor(quickClassToSet);
                                this.style.backgroundColor = newColors.bg; this.style.color = newColors.text;
                                scheduleData.hours[hourIndex][day] = quickClassToSet;
                                window.saveScheduleData(scheduleData); quickClassToSet = null;
                            } else {
                                selectedCells.add(cellId); this.classList.add('selected');
                            }
                        }
                        updateSelectionInfo();
                    };
                    
                    cell.oncontextmenu = function(e) {
                        e.preventDefault();
                        const cellId = `${hourIndex}-${day}`;
                        if (selectedCells.size > 1 && selectedCells.has(cellId)) {
                            selectedCells.forEach(cid => {
                                const [hIdx, d] = cid.split('-');
                                const dayStr = ['mon', 'tue', 'wed', 'thu', 'fri'][parseInt(['mon', 'tue', 'wed', 'thu', 'fri'].indexOf(d))]; // Fix index logic
                                scheduleData.hours[parseInt(hIdx)][d] = ''; 
                            });
                            selectedCells.clear(); window.renderScheduleEditor();
                        } else {
                            this.textContent = ''; this.style.backgroundColor = '#f8fafc'; this.style.color = 'var(--text-main)';
                            scheduleData.hours[hourIndex][day] = '';
                        }
                        window.saveScheduleData(scheduleData); updateSelectionInfo(); return false;
                    };
                }
                row.appendChild(cell);
            });
            tbody.appendChild(row);
        });
        
        if (isEditing) {
            updateSelectionInfo();
            renderQuickClasses();
            renderCustomClassesList();
        }
    };

    window.renderScheduleEditor = function() { window.renderScheduleGeneric('scheduleBodyEditor', true); };
    window.renderScheduleViewer = function() { window.renderScheduleGeneric('scheduleBodyViewer', false); };

    function updateSelectionInfo() {
        const infoDiv = document.getElementById('selectionInfo'); const countSpan = document.getElementById('selectedCount');
        if (selectedCells.size > 0) { infoDiv.style.display = 'flex'; countSpan.textContent = selectedCells.size; } else { infoDiv.style.display = 'none'; }
    }
    window.clearSelectedCells = function() {
        if (selectedCells.size === 0) return;
        if (confirm(`驴Vaciar ${selectedCells.size} celdas?`)) {
            const scheduleData = db.schedule || defaultSchedule;
            selectedCells.forEach(cellId => {
                const [hourIndex, day] = cellId.split('-');
                scheduleData.hours[parseInt(hourIndex)][day] = '';
            });
            selectedCells.clear(); window.saveScheduleData(scheduleData); window.renderScheduleEditor();
        }
    };
    window.clearSelection = function() { selectedCells.clear(); document.querySelectorAll('.schedule-table td.selected').forEach(td => td.classList.remove('selected')); updateSelectionInfo(); };
    function rgbToHex(r, g, b) { return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1); }

    function renderClassPicker() {
        const picker = document.getElementById('classPicker'); if (!picker) return;
        picker.innerHTML = '';
        db.customClasses.forEach((qc, index) => {
            const option = document.createElement('div'); option.className = 'class-option';
            option.textContent = qc.name; option.style.backgroundColor = qc.color || '#4f46e5'; option.style.color = qc.textColor || 'white';
            option.onclick = function(e) {
                e.stopPropagation();
                if (selectedCells.size > 0) {
                    const scheduleData = db.schedule || defaultSchedule;
                    selectedCells.forEach(cellId => {
                        const [hourIndex, day] = cellId.split('-');
                        scheduleData.hours[parseInt(hourIndex)][day] = qc.name;
                    });
                    window.saveScheduleData(scheduleData); selectedCells.clear(); updateSelectionInfo(); window.renderScheduleEditor();
                } else { quickClassToSet = qc.name; showNotification(`Selecciona celda para "${qc.name}"`, "info", 2000); }
                picker.classList.remove('active');
            };
            if (index >= 13) {
                const deleteBtn = document.createElement('span'); deleteBtn.className = 'delete-class'; deleteBtn.innerHTML = '<i class="fas fa-times"></i>';
                deleteBtn.onclick = function(e) { e.stopPropagation(); if (confirm(`驴Eliminar "${qc.name}"?`)) { db.customClasses.splice(index, 1); window.saveData(); renderClassPicker(); renderQuickClasses(); renderCustomClassesList(); } };
                option.appendChild(deleteBtn);
            }
            picker.appendChild(option);
        });
    }

    function renderQuickClasses() {
        const container = document.getElementById('quickClassesContainer'); if (!container) return;
        container.innerHTML = '';
        db.customClasses.forEach((qc) => {
            const option = document.createElement('div'); option.className = 'class-option';
            option.textContent = qc.name; option.style.backgroundColor = qc.color || '#4f46e5'; option.style.color = qc.textColor || 'white';
            option.style.padding = '6px 10px'; option.style.fontSize = '0.8rem';
            option.onclick = function() { quickClassToSet = qc.name; showNotification(`Selecciona celdas para "${qc.name}"`, "info", 3000); };
            container.appendChild(option);
        });
    }
    function renderCustomClassesList() {
        const container = document.getElementById('customClassesList'); if (!container) return;
        container.innerHTML = '';
        db.customClasses.slice(13).forEach((qc, index) => {
            const classItem = document.createElement('div'); classItem.style = 'display:flex;align-items:center;gap:8px;padding:6px 10px;border-radius:6px;border:1px solid var(--border);';
            classItem.style.background = qc.color || '#4f46e5'; classItem.style.color = qc.textColor || 'white';
            classItem.innerHTML = `<div style="width:12px; height:12px; border-radius:50%; background:${qc.textColor || 'white'};"></div><span>${qc.name}</span><button onclick="window.deleteCustomClass(${index + 13})" style="margin-left:auto;background:none;border:none;color:${qc.textColor || 'white'};cursor:pointer;"><i class="fas fa-times"></i></button>`;
            container.appendChild(classItem);
        });
    }
    window.deleteCustomClass = function(index) {
        if (index >= db.customClasses.length) return;
        if (confirm(`驴Eliminar "${db.customClasses[index].name}"?`)) { db.customClasses.splice(index, 1); window.saveData(); renderClassPicker(); renderQuickClasses(); renderCustomClassesList(); }
    };
    window.showClassPicker = function() {
        const picker = document.getElementById('classPicker'); if (!picker) return;
        const btn = document.querySelector('.schedule-actions .btn:last-child');
        if (picker.classList.contains('active')) { picker.classList.remove('active'); } 
        else { const rect = btn.getBoundingClientRect(); picker.style.left = rect.left + 'px'; picker.style.top = (rect.bottom + 10) + 'px'; picker.classList.add('active'); }
    };
    window.openAddClassModal = function() { document.getElementById('newClassName').value = ''; document.getElementById('newClassColorPreview').style.backgroundColor = '#3b82f6'; document.getElementById('addClassModal').classList.add('active'); };
    window.selectClassColor = function(color) { document.getElementById('newClassColorPreview').style.backgroundColor = color; };
    window.addNewClass = function() {
        const name = document.getElementById('newClassName').value.trim(); const color = document.getElementById('newClassColorPreview').style.backgroundColor;
        if (!name) return;
        if (db.customClasses.some(c => c.name.toLowerCase() === name.toLowerCase())) return;
        db.customClasses.push({ name: name, color: color, textColor: color === '#f1f5f9' ? 'var(--text-main)' : 'white' });
        window.saveData(); window.closeModals(); renderClassPicker(); renderQuickClasses(); renderCustomClassesList();
    };
    window.setQuickClass = function(className) { quickClassToSet = className; showNotification(`Selecciona celdas para "${className}"`, "info", 3000); };
    window.addScheduleHour = function() {
        if (!db.schedule) db.schedule = { ...defaultSchedule };
        const lastHour = db.schedule.hours[db.schedule.hours.length - 1]; let newTime = "15:00 - 15:45";
        if (lastHour && lastHour.time) {
            const times = lastHour.time.split(' - ');
            if (times.length === 2) {
                const [start, end] = times;
                const startTime = parseTime(start); const endTime = parseTime(end);
                const duration = endTime - startTime;
                newTime = `${formatTime(startTime + duration)} - ${formatTime(endTime + duration)}`;
            }
        }
        db.schedule.hours.push({ time: newTime, mon: "", tue: "", wed: "", thu: "", fri: "" });
        window.saveScheduleData(db.schedule); window.renderScheduleEditor();
    };
    function parseTime(timeStr) { const [hours, minutes] = timeStr.split(':').map(Number); return hours * 60 + minutes; }
    function formatTime(minutes) { const hrs = Math.floor(minutes / 60); const mins = minutes % 60; return `${hrs.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}`; }
    window.duplicateLastHour = function() {
        if (!db.schedule || !db.schedule.hours || db.schedule.hours.length === 0) return;
        const lastHour = { ...db.schedule.hours[db.schedule.hours.length - 1] };
        db.schedule.hours.push(lastHour); window.saveScheduleData(db.schedule); window.renderScheduleEditor();
    };
    window.removeLastHour = function() {
        if (!db.schedule || !db.schedule.hours || db.schedule.hours.length <= 1) return;
        db.schedule.hours.pop(); window.saveScheduleData(db.schedule); window.renderScheduleEditor();
    };
    window.clearAllHours = function() {
        if (confirm("驴Limpiar todo?")) {
            if (!db.schedule) db.schedule = { ...defaultSchedule };
            db.schedule.hours = db.schedule.hours.map(hour => ({ time: hour.time, mon: "", tue: "", wed: "", thu: "", fri: "" }));
            window.saveScheduleData(db.schedule); window.renderScheduleEditor();
        }
    };
    window.moveHourUp = function(index) { if (!db.schedule || index <= 0) return; const temp = db.schedule.hours[index]; db.schedule.hours[index] = db.schedule.hours[index - 1]; db.schedule.hours[index - 1] = temp; window.saveScheduleData(db.schedule); window.renderScheduleEditor(); };
    window.moveHourDown = function(index) { if (!db.schedule || index >= db.schedule.hours.length - 1) return; const temp = db.schedule.hours[index]; db.schedule.hours[index] = db.schedule.hours[index + 1]; db.schedule.hours[index + 1] = temp; window.saveScheduleData(db.schedule); window.renderScheduleEditor(); };
    window.deleteHour = function(index) { if (!db.schedule || db.schedule.hours.length <= 1) return; if (confirm("驴Eliminar hora?")) { db.schedule.hours.splice(index, 1); window.saveScheduleData(db.schedule); window.renderScheduleEditor(); } };
    window.saveScheduleData = function(scheduleData) { db.schedule = scheduleData; window.saveData(); };
    window.saveScheduleConfig = function() {
        const period = document.getElementById('schedulePeriod').value; const subject = document.getElementById('scheduleSubject').value;
        if (!db.schedule) db.schedule = { ...defaultSchedule };
        db.schedule.period = period || defaultSchedule.period; db.schedule.subject = subject || defaultSchedule.subject;
        window.saveScheduleData(db.schedule); showNotification("Horario guardado", "success");
    };

    document.addEventListener('keydown', function(e) {
        if (e.key === 'Control' || e.key === 'Meta') isCtrlPressed = true;
        if ((e.ctrlKey || e.metaKey) && e.key === 'a' && document.getElementById('configModal').classList.contains('active')) { e.preventDefault(); selectedCells.clear(); document.querySelectorAll('#scheduleBodyEditor td').forEach(td => { if (td.cellIndex > 0) { selectedCells.add(`${td.dataset.hourIndex}-${td.dataset.day}`); td.classList.add('selected'); } }); updateSelectionInfo(); }
        if (e.key === 'Escape') window.clearSelection();
        if (e.key === 'Delete' && selectedCells.size > 0) window.clearSelectedCells();
    });
    document.addEventListener('keyup', function(e) { if (e.key === 'Control' || e.key === 'Meta') isCtrlPressed = false; });

    // --- UI RENDER ---
    function initPickers() { 
        const config = { locale: "es", altInput: true, altFormat: "d/m/y", dateFormat: "Y-m-d", disableMobile: "true" };
        const el1 = document.getElementById("actDate"); if(el1) flatpickrInstances.actDate = flatpickr(el1, config); 
        const el2 = document.getElementById("actEndDate"); if(el2) flatpickrInstances.actEndDate = flatpickr(el2, config); 
        const el3 = document.getElementById("caseDate"); if(el3) flatpickrInstances.caseDate = flatpickr(el3, config);
        const el4 = document.getElementById("actTime"); if(el4) flatpickrInstances.actTime = flatpickr(el4, { enableTime: true, noCalendar: true, dateFormat: "H:i", time_24hr: true, disableMobile: "true" }); 
    }

    window.refreshAllViews = function() {
        if (!db) return; 
        updateWidgets(); applyHeaderStyles();
        if(db.cases) {
            const tc = document.getElementById('dashTotalCases'); if(tc) tc.textContent = db.cases.length;
            const oc = document.getElementById('dashOpenCases'); if(oc) oc.textContent = db.cases.filter(c => c.status !== 'closed').length;
            const so = document.getElementById('sidebarOpenCases'); if(so) so.textContent = (oc ? oc.textContent : '0');
        }
        if(db.activities) {
            const da = document.getElementById('dashActivities'); if(da) da.textContent = db.activities.length;
            const m = currentDate.getMonth(), y = currentDate.getFullYear();
            const monthlyActs = db.activities.filter(a => { if(!a.date) return false; const d = new Date(a.date); return d.getMonth() === m && d.getFullYear() === y; });
            const r1=document.getElementById('dashReuniones'); if(r1) r1.textContent = monthlyActs.filter(a => a.type === 'reunion').length;
            const r2=document.getElementById('dashEntrevistas'); if(r2) r2.textContent = monthlyActs.filter(a => a.type === 'entrevista').length;
            const r3=document.getElementById('dashPlazos'); if(r3) r3.textContent = monthlyActs.filter(a => a.type === 'plazo').length;
            const r4=document.getElementById('dashEfemerides'); if(r4) r4.textContent = monthlyActs.filter(a => a.type === 'efemeride').length;
        }
        const nc = document.getElementById('stickyNotesContainer'); 
        if(nc && db.notes) {
            nc.innerHTML = `<button class="btn btn-secondary" style="width:140px; height:120px; border-style:dashed; font-size:0.8rem; display:flex; align-items:center; justify-content:center;" onclick="window.addStickyNote()">+ Nota</button>`;
            db.notes.forEach((n, i) => {
                const el = document.createElement('div'); el.className = 'sticky-note'; el.style.backgroundColor = n.color || '#fef3c7';
                if(n.width) { el.style.width = n.width; el.style.height = n.height; }
                const colorsHtml = ['#fef3c7','#bbf7d0','#bfdbfe','#fbcfe8','#ddd6fe','#fca5a5','#fed7aa','#e2e8f0','#a7f3d0','#c7d2fe'].map(c => `<div class="color-dot" style="background:${c}" onclick="window.setNoteColor(${i},'${c}')"></div>`).join('');
                el.innerHTML = `<textarea class="sticky-note-content" oninput="window.updateNote(${i}, this.value)">${n.text || ''}</textarea><div class="note-colors">${colorsHtml}</div><i class="fas fa-times note-delete" onclick="window.deleteNote(${i})"></i>`;
                const ro = new ResizeObserver(entries => { for(let e of entries) { db.notes[i].width = e.target.style.width; db.notes[i].height = e.target.style.height; } }); ro.observe(el); nc.appendChild(el);
            });
        }
        const ul = document.getElementById('upcomingEventsList'); 
        if(ul && db.activities) {
            ul.innerHTML = '';
            const today = new Date().toISOString().split('T')[0];
            db.activities.filter(a => a.date >= today).sort((a,b)=>a.date.localeCompare(b.date)).slice(0,4).forEach(a => {
                const d = document.createElement('div'); d.style = `padding:8px; border-radius:8px; border-left:3px solid ${a.color||'var(--primary)'}; background:var(--bg-body); margin-bottom:5px;`;
                d.innerHTML = `<strong>${a.title}</strong><br><small>${window.formatDate(a.date)}</small>`; ul.appendChild(d);
            });
        }
        if(currentViewName === 'calendar') window.renderCalendar();
        if(currentViewName === 'gantt') window.renderGantt();
        if(currentViewName === 'cases') window.renderCasesTable();
        if(currentViewName === 'list') window.renderActivitiesList();
        if(currentViewName === 'schedule') window.renderScheduleViewer();
        applyBackgrounds();
    };

    window.renderGantt = function() {
        const c = document.getElementById('ganttContainer'); if(!c || !db.activities) return;
        c.innerHTML = '';
        const y = currentDate.getFullYear(), m = currentDate.getMonth(); const days = new Date(y, m + 1, 0).getDate();
        const h = document.createElement('div'); h.className = 'gantt-header';
        h.innerHTML = '<div class="gantt-label" style="background:transparent; border:none;">Actividad</div>';
        for(let d=1; d<=days; d++) { 
            const cell = document.createElement('div'); cell.className='gantt-cell'; cell.textContent=d; 
            const currentDayDate = new Date(y, m, d); if(currentDayDate.getDay() === 0 || currentDayDate.getDay() === 6) { cell.style.backgroundColor = "rgba(0,0,0,0.03)"; }
            h.appendChild(cell); 
        }
        c.appendChild(h);
        const mStart = `${y}-${String(m+1).padStart(2,'0')}-01`, mEnd = `${y}-${String(m+1).padStart(2,'0')}-${days}`;
        const iconMap = { 'actividad': 'fa-check-square', 'reunion': 'fa-users', 'entrevista': 'fa-comments', 'plazo': 'fa-hourglass-half', 'efemeride': 'fa-flag' };
        db.activities.filter(a => { if (!a.date) return false; const s = a.date, e = a.endDate || a.date; return (s <= mEnd && e >= mStart); }).forEach(act => {
            const r = document.createElement('div'); r.className='gantt-row';
            const l = document.createElement('div'); l.className='gantt-label'; l.innerHTML = `<span style="overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${act.title}</span>`; r.appendChild(l);
            for(let d=1; d<=days; d++) {
                const bgCell = document.createElement('div'); bgCell.style.flex = "1"; bgCell.style.borderRight = "1px solid var(--border)";
                const currentDayDate = new Date(y, m, d); if(currentDayDate.getDay() === 0 || currentDayDate.getDay() === 6) { bgCell.style.backgroundColor = "rgba(0,0,0,0.03)"; }
                r.appendChild(bgCell);
            }
            const s = new Date(act.date), e = act.endDate ? new Date(act.endDate) : new Date(act.date);
            const vs = new Date(y, m, 1), ve = new Date(y, m, days);
            if (e < vs || s > ve) return; 
            let startD = s < vs ? 1 : s.getDate(); let effEnd = e > ve ? ve : e; const dur = Math.floor((effEnd - (s < vs ? vs : s)) / (1000 * 60 * 60 * 24)) + 1;
            const bar = document.createElement('div'); bar.className='gantt-bar'; bar.style.backgroundColor = act.color || 'var(--primary)';
            const iconClass = iconMap[act.type] || 'fa-circle'; bar.innerHTML = `<i class="fas ${iconClass}"></i> <span>${act.title}</span>`;
            const cellWidth = c.querySelector('.gantt-cell').offsetWidth || 35; 
            bar.style.left = (180 + (startD - 1) * cellWidth) + 'px'; 
            if(window.innerWidth <= 900) { bar.style.left = (120 + (startD - 1) * cellWidth) + 'px'; }
            bar.style.width = ((cellWidth * dur) - 6) + 'px';
            bar.onmousemove = (e) => {
                const tt = document.getElementById('ganttTooltip'); tt.style.display = 'block'; 
                let leftPos = e.pageX + 15; if(leftPos + 200 > window.innerWidth) leftPos = e.pageX - 210; tt.style.left = leftPos + 'px'; tt.style.top = (e.pageY + 10) + 'px';
                tt.innerHTML = `<div style="border-bottom:1px solid rgba(255,255,255,0.2); padding-bottom:4px; margin-bottom:4px;"><i class="fas ${iconClass}"></i> <strong>${act.title}</strong></div><div>Inicio: ${window.formatDate(act.date)} ${act.time||''}</div>${act.endDate ? `<div>Fin: ${window.formatDate(act.endDate)}</div>` : ''}<div style="margin-top:4px; font-style:italic; font-size:0.75rem; color:#cbd5e1;">${act.description || 'Sin descripci贸n'}</div>`;
            };
            bar.onmouseleave = () => { document.getElementById('ganttTooltip').style.display = 'none'; };
            bar.onclick = () => window.editActivity(act.id);
            r.appendChild(bar); c.appendChild(r);
        });
    };

    window.renderCalendar = function() {
        const g = document.getElementById('calendarGrid'); if(!g || !db.activities) return;
        g.innerHTML = '';
        const y = currentDate.getFullYear(), m = currentDate.getMonth();
        const cm = document.getElementById('calMonthYear'); if(cm) cm.textContent = new Intl.DateTimeFormat('es-ES', {month:'long', year:'numeric'}).format(currentDate);
        const daysInMonth = new Date(y, m + 1, 0).getDate(); const firstDay = new Date(y, m, 1).getDay();
        for(let i=0; i<firstDay; i++) g.appendChild(document.createElement('div'));
        for(let d=1; d<=daysInMonth; d++) {
            const dateStr = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
            const cell = document.createElement('div'); cell.className='calendar-day';
            cell.innerHTML = `<div style="text-align:right; font-weight:bold; color:var(--text-light)">${d}</div>`;
            db.activities.filter(a => a.date === dateStr).forEach(a => {
                const ev = document.createElement('div'); ev.className='cal-event';
                ev.style.backgroundColor = a.color || 'var(--primary)'; ev.textContent = a.title;
                ev.onclick = (e) => { e.stopPropagation(); window.editActivity(a.id); };
                ev.onmousemove = (e) => {
                    const tt = document.getElementById('calendarTooltip'); tt.style.display = 'block'; 
                    let left = e.pageX + 10; if (left > window.innerWidth - 200) left = e.pageX - 210; tt.style.left = left + 'px'; tt.style.top = (e.pageY + 10) + 'px';
                    tt.innerHTML = `<strong>${a.title}</strong><br>${window.formatDate(a.date)} ${a.time||''}<br><small>${a.description||''}</small>`;
                };
                ev.onmouseleave = () => { document.getElementById('calendarTooltip').style.display = 'none'; };
                cell.appendChild(ev);
            });
            cell.onclick = () => { window.openActivityModal(); if(flatpickrInstances.actDate) flatpickrInstances.actDate.setDate(dateStr); };
            g.appendChild(cell);
        }
    };

    window.renderCasesTable = function() {
        const t = document.getElementById('casesTableBody'); if(!t || !db.cases) return;
        t.innerHTML = '';
        const searchInput = document.getElementById('caseSearch'); const term = searchInput ? searchInput.value.toLowerCase() : '';
        db.cases.filter(c => (c.student||'').toLowerCase().includes(term)).forEach(c => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${window.formatDate(c.date)}</td><td><strong>${c.student}</strong></td><td>${c.grade}</td><td>${c.type}</td>
                <td>${c.status==='open'?'':(c.status==='progress'?'':'')}</td>
                <td><button class="btn-secondary" onclick="window.editCase('${c.id}')"><i class="fas fa-edit"></i></button></td>`;
            t.appendChild(tr);
        });
    };

    // --- RENDERIZADO DE LISTA ---
    window.renderActivitiesList = function() {
        const c = document.getElementById('activitiesListContainer'); if(!c || !db.activities) return;
        c.innerHTML = '';
        db.activities.sort((a,b)=>b.date.localeCompare(a.date)).forEach(act => {
            const d = document.createElement('div'); 
            const isSelected = selectedActivities.has(act.id);
            d.className = `activity-item ${isSelected ? 'selected' : ''}`;
            d.onclick = (e) => {
                if(e.target.closest('.btn-secondary')) return;
                window.toggleSelection(act.id);
            };

            d.innerHTML = `
                <div style="display:flex; align-items:center; width:100%;">
                    <input type="checkbox" class="item-checkbox" ${isSelected ? 'checked' : ''}>
                    <div style="flex:1;">
                        <strong style="font-size:1rem;">${act.title}</strong>
                        <div style="font-size:0.8rem; color:var(--text-light); margin-top:2px;">
                            <i class="far fa-calendar"></i> ${window.formatDate(act.date)} | ${act.type}
                        </div>
                    </div>
                    <button class="btn-secondary" onclick="window.editActivity('${act.id}')" style="margin-left:10px; padding:8px 12px; z-index:2;">
                        <i class="fas fa-pencil-alt"></i>
                    </button>
                </div>`;
            c.appendChild(d);
        });
        updateBulkBar();
    };

    window.addStickyNote = function() { db.notes.push({text:"Nota", color:"#fef3c7"}); window.saveData(); };
    window.updateNote = function(i, v) { db.notes[i].text = v; db.lastUpdated = Date.now(); saveLocalData(true); };
    window.setNoteColor = function(i, c) { db.notes[i].color = c; window.saveData(); };
    window.deleteNote = function(i) { if(confirm('驴Borrar?')) { db.notes.splice(i,1); window.saveData(); } };
    
    window.switchView = function(v) { 
        currentViewName = v; 
        document.querySelectorAll('.view-container').forEach(e=>e.classList.remove('active')); 
        document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active')); 
        const target = document.getElementById(v+'View'); if(target) target.classList.add('active'); 
        refreshAllViews(); 
        const sb = document.getElementById('sidebar'); if(sb) sb.classList.remove('open');
        const overlay = document.getElementById('sidebarOverlay'); if(overlay) overlay.classList.remove('active');
    };
    window.saveToken = function(val) { GITHUB_TOKEN = val.trim(); localStorage.setItem('sgi_github_token', GITHUB_TOKEN); };
    window.initCloudSync = function() { if(!GITHUB_TOKEN) { alert("Ingresa un token primero"); return; } CloudManager.sync(); };
    window.openConfigModal = function() { 
        document.getElementById('githubToken').value = GITHUB_TOKEN; 
        if(db.config && db.config.alarmType) document.getElementById('configAlarmType').value = db.config.alarmType;
        if(db.config && db.config.subtitle) document.getElementById('configSubtitle').value = db.config.subtitle;
        if(GIST_ID) document.getElementById('currentGistIdDisplay').textContent = GIST_ID;
        window.renderScheduleEditor();
        document.getElementById('configModal').classList.add('active'); 
    };
    window.closeModals = function() { document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('active')); };
    window.changeMonth = function(d) { currentDate.setMonth(currentDate.getMonth()+d); refreshAllViews(); };
    window.resetDate = function() { currentDate = new Date(); refreshAllViews(); };
    window.toggleSidebarFunc = function() { const sb = document.getElementById('sidebar'); const overlay = document.getElementById('sidebarOverlay'); sb.classList.toggle('open'); if(overlay) overlay.classList.toggle('active'); };

    document.getElementById('caseForm').addEventListener('submit', (e) => {
        e.preventDefault(); const id = document.getElementById('caseId').value;
        const newCase = { id: id ? parseInt(id) : Date.now(), date: document.getElementById('caseDate').value, student: document.getElementById('caseStudent').value, grade: document.getElementById('caseGrade').value, status: document.getElementById('caseStatus').value, type: document.getElementById('caseType').value, desc: document.getElementById('caseDesc').value, action: document.getElementById('caseAction').value };
        if(id) { const idx = db.cases.findIndex(x=>x.id==id); if(idx!==-1) db.cases[idx] = newCase; } else db.cases.push(newCase);
        window.saveData(); window.closeModals();
    });
    document.getElementById('activityForm').addEventListener('submit', (e) => {
        e.preventDefault(); const id = document.getElementById('actId').value;
        const newAct = { id: id ? parseInt(id) : Date.now(), title: document.getElementById('actTitle').value, date: document.getElementById('actDate').value, endDate: document.getElementById('actEndDate').value, time: document.getElementById('actTime').value, type: document.getElementById('actType').value, color: document.getElementById('actColor').value, description: document.getElementById('actDesc').value, alarm: parseInt(document.getElementById('actAlarm').value), alarmTriggered: false };
        if(id) { const idx = db.activities.findIndex(x=>x.id==id); if(idx!==-1) db.activities[idx] = newAct; } else db.activities.push(newAct);
        window.saveData(); window.closeModals();
    });
    
    window.deleteActivity = function() { if(confirm('驴Eliminar actividad?')) { db.activities = db.activities.filter(a => a.id != document.getElementById('actId').value); window.saveData(); window.closeModals(); } };
    window.editCase = function(id) {
        const c = db.cases.find(x=>x.id==id); if(!c) return;
        document.getElementById('caseId').value = c.id; document.getElementById('caseStudent').value = c.student; document.getElementById('caseGrade').value = c.grade; document.getElementById('caseStatus').value = c.status; document.getElementById('caseType').value = c.type; document.getElementById('caseDesc').value = c.desc; document.getElementById('caseAction').value = c.action;
        if(flatpickrInstances.caseDate) flatpickrInstances.caseDate.setDate(c.date); document.getElementById('caseModal').classList.add('active');
    };
    window.editActivity = function(id) {
        const a = db.activities.find(x=>x.id==id); if(!a) return;
        document.getElementById('actId').value = a.id; document.getElementById('actTitle').value = a.title; document.getElementById('actType').value = a.type; document.getElementById('actColor').value = a.color; document.getElementById('actDesc').value = a.description; document.getElementById('actAlarm').value = a.alarm || 0;
        if(flatpickrInstances.actDate) flatpickrInstances.actDate.setDate(a.date);
        if(flatpickrInstances.actEndDate && a.endDate) flatpickrInstances.actEndDate.setDate(a.endDate);
        if(flatpickrInstances.actTime && a.time) flatpickrInstances.actTime.setDate(a.time);
        document.getElementById('btnDeleteAct').style.display='block'; document.getElementById('activityModal').classList.add('active');
    };
    window.openCaseModal = () => { document.getElementById('caseForm').reset(); document.getElementById('caseId').value=''; document.getElementById('caseModal').classList.add('active'); };
    window.openActivityModal = () => { document.getElementById('activityForm').reset(); document.getElementById('actId').value=''; document.getElementById('btnDeleteAct').style.display='none'; document.getElementById('activityModal').classList.add('active'); };

    document.addEventListener('DOMContentLoaded', async () => {
        try {
            const localData = localStorage.getItem('sgi_data');
            if (localData) { try { db = ensureIntegrity(JSON.parse(localData)); } catch (e) { console.error("Corrupt Data:", e); db = ensureIntegrity({}); } } else { db = ensureIntegrity({}); }
            initPickers(); if(db.config && db.config.primary) document.documentElement.style.setProperty('--primary', db.config.primary);
            if (GITHUB_TOKEN) { await CloudManager.sync(); } else { showNotification("锔 Token no configurado", "warning"); updateStatus('offline', 'Local'); }
            const btnSidebar = document.getElementById('toggleSidebar'); if(btnSidebar) btnSidebar.addEventListener('click', window.toggleSidebarFunc);
            const searchInput = document.getElementById('caseSearch'); if(searchInput) searchInput.addEventListener('input', window.renderCasesTable);
            const btnTheme = document.getElementById('themeToggle'); if(btnTheme) btnTheme.addEventListener('click', () => { const isDark = document.documentElement.getAttribute('data-theme') === 'dark'; document.documentElement.setAttribute('data-theme', isDark ? 'light' : 'dark'); });
            setInterval(() => { if(GITHUB_TOKEN) CloudManager.sync(true); }, 3000); setInterval(updateWidgets, 5000); setInterval(checkAlarms, 30000);
            refreshAllViews();
            const dateEl = document.getElementById('currentDate'); if(dateEl) dateEl.textContent = new Date().toLocaleDateString('es-ES', {weekday:'long', day:'numeric', month:'long'});
        } catch(err) { console.error("Critical Start Error:", err); alert("Error cr铆tico iniciando: " + err.message); }
    });
    </script>
</body>
</html>
